<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>9&nbsp; Machine Learning Models in PyTorch â€“ MAS3919: Foundations of Machine Learning</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../content/appendix/formula-sheet.html" rel="next">
<link href="../../content/practicals/1-intro-to-pytorch.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-b651517ce65839d647a86e2780455cfb.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-eee127bcbcf69f6d1c4f39497eef8043.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-ca592282aabca1dce090d3def4fc59bb.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/bootstrap/bootstrap-eee127bcbcf69f6d1c4f39497eef8043.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "F"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<script>
  (function () {
    // Compute book root for both environments
    function computeRoots() {
      const onPages = /github\.io$/i.test(location.hostname);
      // >>>> CHANGE THIS to your repo name <<
      const repoBase = '/NCL-MAS2901/';

      if (onPages) {
        // GitHub Pages: use fixed base path
        return { 
          rootPath: repoBase,
          abs: location.origin + repoBase
        };
      } else {
        // Local preview: find the book root by looking for index.html
        // This works by going up the directory tree until we find the root
        let pathSegments = location.pathname.split('/').filter(s => s);
        
        // Remove the current file if it exists
        if (pathSegments.length > 0 && pathSegments[pathSegments.length - 1].includes('.')) {
          pathSegments.pop();
        }
        
        // For local development, we need to find the actual root
        // Quarto typically serves from the root, so we can use '/'
        // If your local setup is different, adjust accordingly
        const rootPath = '/';
        const abs = location.origin + rootPath;
        
        return { rootPath, abs };
      }
    }

    function appendOrReplace(selector, makeEl) {
      const existing = document.querySelector(selector);
      if (existing) existing.remove();
      document.head.appendChild(makeEl());
    }

    const roots = computeRoots();

    // Helper function to build absolute URLs
    function buildUrl(path) {
      // Ensure path doesn't start with /
      const cleanPath = path.replace(/^\//, '');
      // Ensure roots.abs ends with /
      const base = roots.abs.endsWith('/') ? roots.abs : roots.abs + '/';
      return base + cleanPath;
    }

    // Inject links ASAP (don't wait for load)
    appendOrReplace('link[rel="manifest"]', () => {
      const l = document.createElement('link');
      l.rel = 'manifest';
      l.href = buildUrl('pwa/manifest.webmanifest');
      return l;
    });

    // Favicons (tab icons)
    appendOrReplace('link[rel="icon"][sizes="16x16"]', () => {
      const l = document.createElement('link');
      l.rel = 'icon'; 
      l.type = 'image/png'; 
      l.sizes = '16x16';
      l.href = buildUrl('pwa/icons/icon-16.png');
      return l;
    });
    
    appendOrReplace('link[rel="icon"][sizes="32x32"]', () => {
      const l = document.createElement('link');
      l.rel = 'icon'; 
      l.type = 'image/png'; 
      l.sizes = '32x32';
      l.href = buildUrl('pwa/icons/icon-32.png');
      return l;
    });
    
    // Legacy ICO (optional)
    appendOrReplace('link[rel="icon"][type="image/x-icon"]', () => {
      const l = document.createElement('link');
      l.rel = 'icon'; 
      l.type = 'image/x-icon';
      l.href = buildUrl('pwa/icons/favicon.ico');
      return l;
    });

    // Apple touch icon
    appendOrReplace('link[rel="apple-touch-icon"]', () => {
      const l = document.createElement('link');
      l.rel = 'apple-touch-icon';
      l.href = buildUrl('pwa/icons/icon-180.png');
      return l;
    });

    // Register SW (use absolute URL)
    if ('serviceWorker' in navigator) {
      const swUrl = buildUrl('service-worker.js');
      const scope = roots.rootPath.endsWith('/') ? roots.rootPath : roots.rootPath + '/';
      
      navigator.serviceWorker.register(swUrl, { scope: scope })
        .then(reg => console.log('SW registered for scope:', scope))
        .catch(err => console.error('SW registration failed:', err));
    }
  })();
</script>


<link rel="stylesheet" href="../../theming/math-scroll.css">
<link rel="stylesheet" href="../../theming/callout-style.css">
<link rel="stylesheet" href="../../theming/floating-code.css">
<link rel="stylesheet" href="../../theming/font.css">
<link rel="stylesheet" href="../../theming/no-xref-suffix.css">
<link rel="stylesheet" href="../../theming/scrollbar.css">
<link rel="stylesheet" href="../../theming/nav-tabs.css">
<link rel="stylesheet" href="../../theming/header.css">
<link rel="stylesheet" href="../../theming/question-bank.css">
<link rel="stylesheet" href="../../theming/sidebar.css">
<link rel="stylesheet" href="../../theming/lecture-zoom.css">
<link rel="stylesheet" href="../../theming/visualisation-controls.css">
<link rel="stylesheet" href="../../theming/tables.css">
<link rel="stylesheet" href="../../theming/custom-block.css">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../images/ncl_logo_light.png" alt="" class="navbar-logo light-content">
    <img src="../../images/ncl_logo_light.png" alt="" class="navbar-logo dark-content">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">MAS3919: Foundations of Machine Learning</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../content/practicals/1-intro-to-pytorch.html">Practicals</a></li><li class="breadcrumb-item"><a href="../../content/practicals/2-ml-models-in-pytorch.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Machine Learning Models in PyTorch</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../../index.html" class="sidebar-logo-link">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Lecture Notes</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/main/1-overview-of-machine-learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Overview of Machine Learning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/main/2-machine-learning-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Machine Learning Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/main/3-stochastic-optimisation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Stochastic Optimisation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/main/4-generalisation-error.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Generalisation Error</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/main/5-online-supervised-learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Online Supervised Learning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/main/6-beyond-supervised-learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Beyond Supervised Learning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/main/7-ethics-of-ml.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Ethics of Machine Learning</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Practicals</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/practicals/1-intro-to-pytorch.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Introduction to PyTorch</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/practicals/2-ml-models-in-pytorch.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Machine Learning Models in PyTorch</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Additional Material</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/appendix/formula-sheet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Formula Sheet</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/appendix/revision-sheet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Revision Sheet</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/appendix/distribution-explorer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Distribution Explorer</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/appendix/question-bank.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Question Bank</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/ide/python-ide.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Python IDE</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
        
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../content/practicals/1-intro-to-pytorch.html">Practicals</a></li><li class="breadcrumb-item"><a href="../../content/practicals/2-ml-models-in-pytorch.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Machine Learning Models in PyTorch</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Machine Learning Models in PyTorch</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>





</main> <!-- /main -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.xref-no-num a.quarto-xref').forEach(a => {
    const nodes = Array.from(a.childNodes);
    // Find the trailing <span> (the number)
    const last = nodes[nodes.length - 1];
    const prev = nodes[nodes.length - 2];

    if (last && last.nodeType === Node.ELEMENT_NODE && last.tagName === 'SPAN') {
      // Remove the number <span>
      last.remove();
      // Strip any trailing NBSP/space left before it
      if (prev && prev.nodeType === Node.TEXT_NODE) {
        prev.nodeValue = prev.nodeValue.replace(/\u00a0\s*$/, '');
      }
    }
  });
});
</script>
<script>
(function () {
  if (window.__closeCodeFoldBound) return;
  window.__closeCodeFoldBound = true;

  const onDocClick = (e) => {
    // Close any open code-fold if the click is outside it
    document.querySelectorAll('details.code-fold[open]').forEach((d) => {
      if (!d.contains(e.target)) d.removeAttribute('open');
    });
  };

  const onKey = (e) => {
    if (e.key === 'Escape') {
      document.querySelectorAll('details.code-fold[open]').forEach((d) => {
        d.removeAttribute('open');
      });
    }
  };

  // Capture-phase click so we run reliably even with other handlers
  document.addEventListener('click', onDocClick, true);
  document.addEventListener('keydown', onKey);
})();
</script>



<script>
document.addEventListener('DOMContentLoaded', function () {
  // 1) Find the brand container and the existing logo <img>
  const brandContainer = document.querySelector('#quarto-header .navbar-brand-container');
  const img = brandContainer && brandContainer.querySelector('img.navbar-logo');
  if (!brandContainer || !img) return;

  // 2) Build an <a> like Quarto's, and inject inline SVG inside it
  const a = document.createElement('a');
  a.className = 'navbar-brand navbar-brand-logo';
  a.href = (img.closest('a') && img.closest('a').getAttribute('href')) || '/';

  a.innerHTML = `
        <svg class="navbar-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 181 52" fill="none">
            <g class="logo-text" fill="currentColor">
                <path d="M71.52 21.8003C66.9224 21.8003 63.928 18.5373 63.928 13.673C63.928 8.92948 67.1342 5.48517 71.7317 5.48517C76.1175 5.48517 78.8398 8.59713 78.8398 13.7938C78.8398 14.0053 78.8398 14.2168 78.8398 14.4283H68.4953C68.4953 17.1475 69.6749 18.5977 71.7015 18.5977C73.1231 18.5977 74.212 17.7518 74.6052 16.2713L78.749 16.6339C77.7811 19.9271 75.1496 21.8003 71.52 21.8003ZM74.3632 11.8904C74.333 9.62439 73.2743 8.44607 71.4595 8.44607C69.7657 8.44607 68.6465 9.68481 68.5558 11.8904H74.3632Z"/>
                <path d="M173.18 21.8003C168.583 21.8003 165.588 18.5373 165.588 13.673C165.588 8.92948 168.794 5.48517 173.392 5.48517C177.778 5.48517 180.5 8.59713 180.5 13.7938C180.5 14.0053 180.5 14.2168 180.5 14.4283H170.155C170.155 17.1475 171.335 18.5977 173.362 18.5977C174.783 18.5977 175.872 17.7518 176.265 16.2713L180.409 16.6339C179.441 19.9271 176.81 21.8003 173.18 21.8003ZM176.023 11.8904C175.993 9.62439 174.934 8.44607 173.12 8.44607C171.426 8.44607 170.307 9.68481 170.216 11.8904H176.023Z"/>
                <path d="M79.2632 5.9082H84.1027L86.3712 15.0024L88.5188 5.9082H92.5416L94.7799 15.1535L97.4719 5.9082H101.102L96.625 21.3774H92.5719L90.0009 11.3164L87.4601 21.3774H83.7397L79.2632 5.9082Z"/>
                <path d="M109.268 8.62735C107.302 8.62735 105.971 10.3193 105.911 13.6125C105.85 16.9058 107.211 18.6279 109.117 18.6279C110.599 18.6279 112.021 17.4798 112.263 15.4858L116.104 15.939C115.59 19.5041 112.747 21.8003 108.784 21.8003C104.187 21.8003 101.041 18.5373 101.132 13.673C101.223 8.7482 104.519 5.48517 109.419 5.48517C113.14 5.48517 115.711 7.66052 116.134 11.3465L112.142 11.7695C111.9 9.74524 110.629 8.62735 109.268 8.62735Z"/>
                <path d="M127.477 18.8696C126.479 20.7429 124.785 21.7701 122.607 21.7701C119.401 21.7701 117.465 19.8969 117.465 17.0568C117.465 13.4313 120.793 11.4976 127.386 11.4372V10.7725C127.386 9.2014 126.57 8.38564 124.936 8.38564C123.122 8.38564 122.093 9.14097 121.881 10.561L117.889 10.1078C118.584 7.05626 121.034 5.51538 125.178 5.51538C129.806 5.51538 131.621 7.32818 131.621 11.558V18.4164C131.621 19.6854 131.742 20.6824 132.044 21.4076H127.78C127.598 20.6522 127.507 19.8063 127.477 18.8696ZM122.002 16.7849C122.002 18.0539 122.819 18.8092 124.241 18.8092C126.055 18.8092 127.417 17.2986 127.417 15.2138V13.7938C123.817 13.8542 122.002 14.9419 122.002 16.7849Z"/>
                <path d="M136.914 16.5432C137.277 17.9632 138.578 18.779 140.483 18.779C142.117 18.779 143.024 18.0539 143.024 17.0871C143.024 15.7275 141.723 15.7879 139.455 15.3045C135.795 14.5491 133.95 13.3104 133.95 10.5308C133.95 7.63031 136.309 5.48517 140.181 5.48517C143.357 5.48517 145.504 6.90519 146.412 9.50353L142.964 10.1682C142.449 8.92948 141.512 8.41586 140.03 8.41586C138.608 8.41586 137.822 8.95969 137.822 9.95673C137.822 11.3163 139.304 11.2559 142.086 11.8602C145.444 12.5853 147.077 13.7938 147.077 16.4828C147.077 19.5343 144.506 21.7097 140.12 21.7097C136.581 21.7097 134.071 19.9271 133.345 17.0568L136.914 16.5432Z"/>
                <path d="M159.206 0.5H163.622V21.3774H159.206V0.5Z"/>
                <path d="M68.7374 33.9461C69.3726 32.8886 70.1287 32.0729 71.0059 31.5592C71.8831 31.0154 72.851 30.7435 73.9399 30.7435C74.8775 30.7435 75.6639 30.9247 76.2991 31.3175C76.9343 31.6801 77.4485 32.2843 77.8417 33.1001C78.2349 33.9159 78.4164 34.8223 78.4164 35.8193V42.8288C78.4164 43.3424 78.5374 43.7352 78.7794 43.9467C79.0214 44.1582 79.4146 44.279 79.959 44.279H80.9572V45.3969H73.3954V44.279H74.1213C74.7868 44.279 75.2707 44.1582 75.5127 43.9467C75.7849 43.7352 75.9059 43.4028 75.9059 42.9798V36.8466C75.9059 35.5172 75.6942 34.5201 75.301 33.8856C74.7263 32.9793 73.8794 32.4958 72.73 32.4958C71.5806 32.4958 70.6429 32.949 69.8868 33.8856C69.1306 34.8223 68.7374 36.0308 68.7374 37.5112V42.8288C68.7374 43.3424 68.8584 43.705 69.1003 43.9467C69.3423 44.1582 69.7355 44.279 70.28 44.279H71.2781V45.3969H63.5954V44.279H64.5935C65.0775 44.279 65.4707 44.1884 65.7429 43.9769C66.0151 43.7654 66.1361 43.5237 66.1361 43.2215V33.9159C66.1361 33.3116 65.9849 32.8282 65.6522 32.5261C65.3195 32.2239 64.8355 32.0426 64.2306 32.0426H63.5046V31.0154L68.6164 30.7737L68.7374 33.9461Z"/>
                <path d="M81.2292 31.0759L87.0064 30.8946V43.2518C87.0064 43.5842 87.0972 43.8259 87.2484 43.9769C87.4904 44.1884 87.7928 44.2791 88.1558 44.2791H89.7892V45.3969H81.562V44.2791H83.0743C83.528 44.2791 83.8607 44.1582 84.0725 43.9467C84.2842 43.7352 84.3749 43.4029 84.3749 42.9799V33.9159C84.3749 33.3419 84.2237 32.9189 83.891 32.6167C83.5583 32.3146 83.0743 32.1937 82.4391 32.1937H81.2595V31.0759M85.2823 25.0332C85.7361 25.0332 86.1595 25.2145 86.4922 25.5468C86.8249 25.9094 87.0064 26.3022 87.0064 26.7856C87.0064 27.2388 86.8249 27.6315 86.4922 27.9941C86.1595 28.3265 85.7361 28.5077 85.2823 28.5077C84.7984 28.5077 84.4052 28.3265 84.0725 27.9941C83.7397 27.6618 83.5583 27.2388 83.5583 26.7856C83.5583 26.3324 83.7397 25.9094 84.0725 25.577C84.4354 25.2145 84.8286 25.0332 85.2823 25.0332Z"/>
                <path d="M144.99 31.0759L150.767 30.8946V43.2518C150.767 43.5842 150.858 43.8259 151.009 43.9769C151.251 44.1884 151.554 44.2791 151.917 44.2791H153.55V45.3969H145.292V44.2791H146.805C147.259 44.2791 147.591 44.1582 147.803 43.9467C148.015 43.7352 148.105 43.4029 148.105 42.9799V33.9159C148.105 33.3419 147.954 32.9189 147.621 32.6167C147.289 32.3146 146.805 32.1937 146.17 32.1937H144.99V31.0759ZM149.043 25.0332C149.497 25.0332 149.92 25.2145 150.253 25.5468C150.616 25.9094 150.767 26.3022 150.767 26.7856C150.767 27.2388 150.586 27.6315 150.253 27.9941C149.92 28.3265 149.497 28.5077 149.043 28.5077C148.559 28.5077 148.166 28.3265 147.833 27.9941C147.5 27.6618 147.319 27.2388 147.319 26.7856C147.319 26.3324 147.5 25.9094 147.833 25.577C148.166 25.2145 148.589 25.0332 149.043 25.0332Z"/>
                <path d="M88.791 31.0154H95.8991V32.0728C94.9614 32.1031 94.3565 32.1635 94.0842 32.3146C93.812 32.4656 93.691 32.6771 93.691 32.949C93.691 33.1605 93.7515 33.4022 93.8423 33.6137L97.6534 42.1037L101.162 33.8554C101.223 33.7044 101.253 33.5835 101.253 33.4324C101.253 32.6771 100.497 32.2239 99.0145 32.0426V31.0154H105.003V32.0728C104.398 32.1333 103.915 32.2843 103.552 32.5563C103.189 32.8282 102.916 33.1605 102.705 33.6137L97.4114 45.8501H96.5645L90.9386 33.2814C90.7268 32.8282 90.4849 32.526 90.1824 32.3448C89.8799 32.1635 89.4262 32.0728 88.791 32.0728V31.0154Z"/>
                <path d="M117.677 38.2968H107.302C107.363 40.5024 107.756 42.0432 108.542 42.9496C109.419 43.9769 110.569 44.4603 111.93 44.4603C113.957 44.4603 115.59 43.3424 116.83 41.0764L117.798 41.4994C116.286 44.3999 114.138 45.8501 111.295 45.8501C109.359 45.8501 107.726 45.1552 106.425 43.7654C105.094 42.3756 104.459 40.593 104.459 38.4176C104.459 36.0912 105.094 34.1878 106.395 32.7375C107.695 31.2873 109.299 30.5622 111.204 30.5622C112.595 30.5622 113.805 30.9248 114.834 31.6499C115.832 32.375 116.618 33.4022 117.132 34.7316C117.465 35.6682 117.647 36.8768 117.677 38.2968ZM107.302 37.2393H113.654C114.017 37.2393 114.32 37.1185 114.531 36.8768C114.743 36.6351 114.834 36.2121 114.834 35.5776C114.834 34.4597 114.471 33.4929 113.745 32.7073C113.019 31.9218 112.172 31.529 111.204 31.529C110.115 31.529 109.208 32.0124 108.452 32.949C107.726 33.8857 107.332 35.3359 107.302 37.2393Z"/>
                <path d="M133.012 40.0794C133.647 41.862 134.373 43.1007 135.22 43.7654C136.037 44.4603 137.065 44.7926 138.275 44.7926C139.394 44.7926 140.272 44.5509 140.846 44.0675C141.451 43.5841 141.754 42.9496 141.754 42.1943C141.754 41.7713 141.633 41.3785 141.421 41.0462C141.209 40.7138 140.907 40.4721 140.514 40.3211C140.12 40.17 139.092 39.9283 137.459 39.6262C135.886 39.324 134.797 38.9917 134.192 38.6593C133.587 38.327 133.103 37.8436 132.77 37.2695C132.438 36.6653 132.256 36.0308 132.256 35.3359C132.256 34.2784 132.619 33.3116 133.315 32.4656C134.222 31.3779 135.493 30.8039 137.126 30.8039C138.366 30.8039 139.515 31.1967 140.604 32.0124L141.633 30.9247H142.268L142.661 36.0912H141.663C141.209 34.6108 140.604 33.5231 139.818 32.8584C139.062 32.1937 138.094 31.8614 136.975 31.8614C136.007 31.8614 135.22 32.1031 134.676 32.5865C134.131 33.0699 133.829 33.6742 133.829 34.3691C133.829 34.9733 134.071 35.4869 134.585 35.9099C135.099 36.3329 136.067 36.6653 137.549 36.8768C139.243 37.1487 140.362 37.3904 140.877 37.6019C141.723 37.904 142.359 38.3874 142.812 39.0219C143.266 39.6564 143.508 40.4419 143.508 41.3483C143.508 42.6173 142.994 43.6747 141.996 44.5509C140.997 45.4271 139.727 45.8803 138.185 45.8803C136.763 45.8803 135.432 45.3969 134.222 44.4905L133.103 45.7595H132.286L131.984 40.1096H133.012"/>
                <path d="M164.167 31.0154H171.093V32.0728H170.458C169.853 32.0728 169.43 32.1635 169.218 32.3146C169.006 32.4656 168.885 32.7073 168.885 32.9792C168.885 33.1001 168.916 33.2512 168.976 33.372L172.999 41.9828L176.024 34.8525C176.235 34.3388 176.356 33.8554 176.356 33.372C176.356 33.0095 176.205 32.7073 175.903 32.4958C175.6 32.2843 175.025 32.1635 174.118 32.1031V31.0154H180.107V32.0728C178.958 32.1937 178.201 32.6771 177.808 33.5835L172.394 45.9709C171.486 48.0859 170.549 49.5361 169.641 50.2914C168.704 51.077 167.736 51.4698 166.677 51.4698C165.921 51.4698 165.286 51.2583 164.832 50.8353C164.378 50.4123 164.136 49.8987 164.136 49.2944C164.136 48.8412 164.288 48.4484 164.56 48.1463C164.862 47.8442 165.195 47.6931 165.649 47.6931C166.042 47.6931 166.375 47.814 166.647 48.0859C166.919 48.3276 167.04 48.6297 167.04 48.9923C167.04 49.1131 167.01 49.2642 166.98 49.4455C166.949 49.5965 166.919 49.7174 166.919 49.7778C166.919 50.0195 167.07 50.1404 167.403 50.1404C167.736 50.1404 168.129 50.0195 168.553 49.7778C168.976 49.5361 169.369 49.1433 169.762 48.5995C170.125 48.0557 170.791 46.8471 171.698 44.9739L166.224 33.3116C166.012 32.9188 165.77 32.6167 165.498 32.4052C165.195 32.2239 164.772 32.0728 164.197 32.0124V31.0154"/>
                <path d="M44.0557 0.5H49.7119L57.6366 13.3709L57.6063 0.5H62.0526V21.3774H57.3341L48.4717 6.875V21.3774H44.0557V0.5Z"/>
                <path d="M41.4243 24.5195H50.8614V25.6374H49.2885C48.7441 25.6374 48.3509 25.7281 48.1089 25.9093C47.8972 26.0906 47.7762 26.3625 47.7762 26.7553V38.1759C47.7762 39.5053 47.8972 40.5326 48.1392 41.2275C48.4719 42.2547 49.1373 43.0403 50.0447 43.6445C50.9824 44.2488 52.1923 44.5509 53.6744 44.5509C55.7312 44.5509 57.304 44.0071 58.3929 42.9496C59.4818 41.8922 60.0262 40.4419 60.0262 38.6593V29.6256C60.0262 28.689 59.9657 27.9941 59.8447 27.5409C59.7238 27.0574 59.5423 26.6949 59.3003 26.423C59.0583 26.151 58.7559 25.9698 58.3929 25.8187C58.0299 25.6978 57.3947 25.6374 56.5478 25.6374V24.5195H65.1985V25.6374H64.5935C63.6256 25.6374 62.9299 25.9093 62.446 26.423C61.962 26.9366 61.7503 27.6919 61.7503 28.689V38.4478C61.7503 40.8951 61.0546 42.7683 59.6633 44.0675C58.0904 45.548 56.0034 46.2731 53.4021 46.2731C51.1336 46.2731 49.3793 45.9407 48.0787 45.3063C46.778 44.6718 45.8404 43.7352 45.2657 42.5569C44.812 41.6505 44.6003 40.5024 44.6003 39.1125V26.7553C44.6003 26.423 44.4793 26.1208 44.2373 25.9396C43.9953 25.7281 43.6323 25.6374 43.1484 25.6374H41.5151V24.5195"/>
                <path d="M157.18 18.1747C156.696 18.2654 156.242 18.3258 155.849 18.3258C154.306 18.3258 153.973 17.6309 153.973 15.8785V8.92948H157.18V5.93836H153.973V1.43658L149.497 2.25234V5.90815H147.5V8.89926H149.497V16.3317C149.497 20.1084 150.949 21.7701 154.578 21.7701C155.395 21.7701 156.272 21.6795 157.18 21.4982V18.1747Z"/>
                <path d="M163.199 39.9283C163.108 41.439 162.836 42.5267 162.352 43.1914C161.868 43.8561 161.263 44.1884 160.567 44.1884C159.992 44.1884 159.509 43.9769 159.115 43.5539C158.722 43.131 158.541 42.4965 158.541 41.6807V32.2844H163.078V31.0154H158.541V25.0332H157.482C157.391 27.0575 156.907 28.6286 156 29.7465C155.395 30.532 154.487 31.0154 153.308 31.1967V32.2542H155.879V42.1037C155.879 43.1914 156.212 44.0374 156.907 44.702C157.603 45.3667 158.541 45.6991 159.75 45.6991C161.051 45.6991 162.14 45.2157 162.957 44.2791C163.773 43.3424 164.227 41.8922 164.288 39.9283H163.199Z"/>
                <path d="M129.201 30.5018C126.691 30.5018 124.573 33.4325 123.696 36.7257V30.7737L118.463 31.0154V32.1333H119.704C120.248 32.1333 120.671 32.2844 120.974 32.6167C121.276 32.949 121.428 33.4325 121.428 34.1576V43.3122C121.428 43.5841 121.307 43.7956 121.065 44.0071C120.823 44.1884 120.46 44.279 119.976 44.279H118.554V45.3969H127.537V44.279H125.723C125.118 44.279 124.694 44.1884 124.452 44.0071C124.21 43.8258 124.089 43.5539 124.089 43.2216V40.5628C124.089 37.7832 125.269 33.0699 127.598 33.0699C128.233 33.0699 128.112 34.0971 129.383 34.0971C130.411 34.0971 131.137 33.3418 131.137 32.3448C131.137 31.2269 130.229 30.5018 129.201 30.5018Z"/>
            </g>
            <path d="M0.5 0.5C0.5 0.5 0.5 12.827 0.5 18.8092C0.5 36.1214 20.0093 46.122 20.0093 46.122C20.0093 46.122 39.5187 36.1819 39.5187 18.8092C39.5187 12.827 39.5187 0.5 39.5187 0.5H0.5Z" fill="#003A65"/>
            <path d="M38.3088 1.70853V18.8092C38.3088 22.5557 37.3409 26.2417 35.4353 29.8069C33.8927 32.6771 31.7149 35.4568 28.9927 38.0551C25.2421 41.6505 21.4309 43.9467 20.0396 44.7322C18.6482 43.9467 14.8673 41.6505 11.1167 38.0551C8.36422 35.4568 6.15619 32.6771 4.61359 29.8069C2.67779 26.2417 1.70988 22.5557 1.70988 18.8092C1.70988 13.9751 1.70988 4.97156 1.70988 1.70853H38.3088ZM39.5187 0.5H0.5C0.5 0.5 0.5 12.827 0.5 18.8092C0.5 36.1214 20.0093 46.122 20.0093 46.122C20.0093 46.122 39.5187 36.1819 39.5187 18.8092C39.5187 12.827 39.5187 0.5 39.5187 0.5Z" fill="white"/>
            <path d="M30.626 31.4082C30.626 30.3507 30.4747 29.3235 30.1723 28.3264C27.2686 30.2299 24.4253 30.7133 22.7013 29.686C22.792 29.5652 22.8525 29.4141 22.8525 29.2631C22.8525 28.8703 22.55 28.5682 22.1568 28.5682C22.0056 28.5682 21.8543 28.6286 21.7334 28.7192C20.705 27.0273 21.1889 24.157 23.0945 21.2565C22.0963 20.9544 21.0679 20.8033 20.0093 20.8033C18.9506 20.8033 17.9222 20.9544 16.9241 21.2565C18.8296 24.157 19.3136 26.9971 18.2852 28.7192C18.1642 28.6286 18.013 28.5682 17.8617 28.5682C17.4685 28.5682 17.1661 28.8703 17.1661 29.2631C17.1661 29.4141 17.2266 29.5652 17.3173 29.686C15.6235 30.7133 12.75 30.2299 9.84628 28.3264C9.54381 29.3235 9.39258 30.3507 9.39258 31.4082C9.39258 32.4657 9.54381 33.4929 9.84628 34.49C12.75 32.5865 15.5932 32.1031 17.3173 33.1304C17.2266 33.2512 17.1661 33.4023 17.1661 33.5533C17.1661 33.9461 17.4685 34.2483 17.8617 34.2483C18.013 34.2483 18.1642 34.1878 18.2852 34.0972C19.3136 35.7891 18.8296 38.6594 16.9241 41.5599C17.9222 41.862 18.9506 42.0131 20.0093 42.0131C21.0679 42.0131 22.0963 41.862 23.0945 41.5599C21.1889 38.6594 20.705 35.8193 21.7334 34.0972C21.8543 34.1878 22.0056 34.2483 22.1568 34.2483C22.55 34.2483 22.8525 33.9461 22.8525 33.5533C22.8525 33.4023 22.792 33.2512 22.7013 33.1304C24.3951 32.1031 27.2686 32.5865 30.1723 34.49C30.4747 33.4929 30.626 32.4657 30.626 31.4082Z" fill="white"/>
            <path d="M21.9451 31.4082C21.9451 32.4657 21.0982 33.3418 20.0093 33.3418C18.9507 33.3418 18.0735 32.4959 18.0735 31.4082C18.0735 30.3507 18.9204 29.4745 20.0093 29.4745C21.0679 29.5048 21.9451 30.3507 21.9451 31.4082Z" fill="#003A65"/>
            <path d="M38.3693 1.61792H1.61914V18.8093H38.3693V1.61792Z" fill="white"/>
            <path d="M22.9736 13.8543C23.1551 13.9751 23.0643 14.1262 22.9736 14.2169C22.8828 14.3075 21.9452 14.9118 21.3402 14.7305C20.8865 14.5794 20.8865 13.7637 20.2513 13.4917C19.7371 13.2802 19.1624 13.673 19.1624 13.673C20.0699 13.6428 20.3421 14.942 20.3421 14.942C18.9507 13.8543 17.6803 14.6096 17.5896 15.3045C18.7995 14.5794 19.7371 15.5764 19.7371 15.5764C19.3137 15.6369 18.3458 16.3318 19.0717 17.4497C19.1927 16.1505 20.4933 15.939 20.4933 15.939C20.3723 16.5433 20.9168 17.7518 21.9452 17.5101C21.2192 17.0267 21.3402 16.5433 21.3402 16.2109C21.3402 16.0296 21.552 15.9088 21.7939 15.8786C23.2155 15.7275 23.2155 16.8152 23.2155 16.8152C23.6088 16.785 24.6674 15.365 24.6069 14.6398C25.0001 15.2441 26.0588 15.5764 26.8149 15.0326C25.847 14.8815 25.4236 13.9147 25.3631 13.7334C25.3026 13.5522 25.0606 12.3738 24.6069 11.9206C23.9717 11.2862 22.9433 11.7696 22.4291 12.2832C22.2476 12.4343 21.7637 13.3105 22.3686 13.5824C22.7921 13.7032 22.8828 13.7939 22.9736 13.8543Z" fill="#D70929"/>
            <path d="M7.51742 11.0143C6.03532 11.0143 4.37173 8.02315 4.2205 7.78144C5.06741 7.72102 5.03717 7.29803 4.94643 7.02611C4.64396 6.02907 2.73839 6.96568 2.58716 7.14696C2.64765 6.18014 3.7063 5.78737 4.34149 5.90822C4.2205 4.42777 2.85938 4.33713 2.85938 4.33713C4.03902 3.46094 4.79519 4.57884 5.03717 5.42481C6.2168 4.54862 5.09766 3.37031 4.88593 3.24945C4.88593 3.24945 5.82359 3.15881 6.2168 4.12564C6.57976 5.03203 6.12606 5.57587 6.12606 5.57587C6.12606 5.57587 6.42853 5.57587 6.61001 5.42481C7.27545 4.97161 7.2452 4.36734 7.21495 4.24649C7.21495 4.24649 7.6989 4.54862 7.63841 5.12267C7.60816 5.51545 7.21495 5.81758 7.03347 6.02907C6.88224 6.24057 6.48902 6.69376 6.97298 8.144C7.21495 8.83891 7.57792 9.38275 7.85014 9.5036C7.66866 9.77552 7.39643 10.1381 7.51742 11.0143Z" fill="#D70929"/>
            <path d="M4.25067 13.1897C3.31301 13.2501 1.67967 13.6429 2.52659 15.3348C2.55684 14.1867 4.09944 14.0658 4.40191 14.1565C3.64573 15.4254 4.52289 16.634 5.21858 16.5735C4.52289 16.0297 5.15808 15.2139 5.21858 14.942C5.27907 14.7305 5.52105 14.6097 5.79327 14.7003C6.64019 14.942 6.03525 15.6671 6.03525 15.6671C7.91056 16.5131 8.75748 15.788 9.12044 15.365C9.12044 15.365 9.69513 15.9089 9.12044 16.3318C9.42291 16.5131 11.2075 16.5735 11.8729 15.7578C12.0846 16.4225 14.2019 16.4225 14.5347 16.1203C14.5347 16.1203 14.1112 15.8786 14.1112 15.5765C14.1112 15.0629 14.6859 14.6399 15.4118 14.3378C16.2587 13.9752 17.6199 13.7939 19.0112 13.1594C21.552 11.9509 24.6977 9.71513 25.6958 11.1049C26.21 11.8301 26.089 12.525 26.6032 13.0084C27.1174 13.4918 27.9341 13.2803 28.4483 13.2199C29.6884 13.0688 31.473 12.8875 32.5619 12.8271C33.6508 12.7667 33.9532 13.5522 33.9532 13.6429C34.044 13.8846 33.923 14.0356 33.7718 14.0054C33.4088 13.9752 32.7434 13.8241 32.3502 14.0356C31.8057 14.3378 31.9569 15.0931 31.9569 15.0931C32.4106 14.3075 33.681 14.4284 34.1347 14.4888C33.7113 14.8514 32.9248 16.2714 34.044 16.9059C33.7415 15.8182 34.7699 15.0629 34.7699 15.0629C34.8607 15.365 35.5261 15.9995 37.0082 15.9089C35.4656 15.4254 35.7076 14.6399 35.7076 14.6399C36.2218 14.8514 37.3107 14.7003 37.8249 13.5824C36.0705 14.6701 35.5866 13.6429 35.5261 13.522C35.2236 12.9782 36.0705 12.8573 36.0705 12.8573C35.8891 12.4948 33.4693 10.9841 34.6792 10.5309C34.2557 10.2892 33.2576 10.3798 32.3804 11.0445C32.4106 10.833 32.3804 10.259 32.1082 10.0173C32.1082 10.0173 30.6563 11.0143 29.5069 10.833C28.3575 10.6517 28.8113 8.92959 28.8113 8.92959C28.8113 8.92959 31.7452 9.29215 32.8341 8.77852C33.923 8.26489 33.923 7.50956 34.8304 7.02615C35.5563 6.63338 36.4335 6.96572 36.4335 6.96572C36.3125 6.21039 34.8607 5.60613 33.7718 6.78444C33.7718 6.78444 33.681 4.6393 31.0798 4.91122C29.4464 5.06229 28.2366 5.72698 26.5427 6.02911C24.9094 6.33124 23.3668 6.60316 22.3384 6.60316C21.31 6.60316 19.8279 6.33124 19.7069 5.18314C19.6464 4.51845 20.1606 4.21632 20.6748 4.21632C21.4612 4.21632 22.5501 4.66952 23.4273 4.97165C24.0625 5.18314 24.6674 5.18314 25.0304 5.18314C25.968 5.18314 27.1174 4.72994 27.6921 4.48824C28.2668 4.24653 28.7508 4.12568 29.8699 4.21632C29.5069 3.76312 27.0267 2.67544 25.3328 2.76608C23.7298 2.85672 23.6088 3.61205 22.0359 3.52141C20.4631 3.46098 19.0717 3.70269 19.0112 4.91122C18.981 6.08954 20.0094 7.3585 22.6106 7.17722C23.6693 7.11679 27.6014 6.4521 28.3878 6.21039C29.4162 5.87805 33.3483 5.12271 32.5921 7.05636C32.4409 7.47935 31.9569 7.90234 30.8076 7.90234C29.6582 7.90234 28.2063 7.56999 27.8131 7.50956C27.4199 7.44914 26.3915 7.32828 25.3933 7.47935C24.4557 7.6002 17.9828 8.53681 16.8032 8.68788C16.8032 9.08065 16.5612 10.3194 17.6803 11.0143C17.1964 11.256 16.2285 11.7394 15.2908 11.3466C15.2303 11.6488 15.5933 12.2228 16.0168 12.7062C15.6538 12.8271 14.2624 13.4918 13.5365 13.0084C13.234 13.522 12.3871 14.8212 10.2698 14.3982C10.3908 14.3075 10.3303 13.6731 9.84637 13.4616C9.33217 13.522 9.27168 13.8241 7.21488 13.5824C6.60994 13.522 6.09574 13.3105 5.91426 12.9177C5.73277 12.4948 5.97475 11.9207 5.85376 11.5884C5.58154 10.8934 4.55314 10.9841 4.55314 10.9841C5.46055 11.679 4.85561 12.6458 4.85561 12.6458C4.0087 11.7998 2.67783 10.9539 2.22412 12.4645C3.58524 11.9207 4.25067 13.1897 4.25067 13.1897Z" fill="#D70929"/>
            <path d="M17.4988 5.57586C16.9846 4.57882 15.8352 5.30394 15.8352 5.30394C16.1376 4.94138 15.8654 3.82349 15.4722 3.58178C15.4722 4.15583 14.9883 4.33711 14.6253 4.24647C14.1716 4.12562 14.3531 3.49114 14.4741 3.21922C14.1111 3.18901 13.3852 3.15879 12.871 3.88391C12.75 2.97751 11.9031 2.58474 11.0561 2.82645C11.9636 3.88391 9.9975 5.0018 9.30182 4.66946C8.9691 5.33415 10.058 6.11969 10.2092 5.9082C9.63454 6.75417 8.69688 6.57289 8.15243 6.39161C8.12219 6.75417 8.54565 7.53972 9.30182 7.53972C8.90861 8.14398 8.03145 8.20441 7.78947 8.08356C7.66848 8.65761 8.63639 9.20145 8.87836 9.23166C8.09194 10.4704 8.36416 12.0113 8.78762 12.6155L9.09009 13.1292C9.72528 11.8602 11.2074 12.3436 10.9654 13.5824C12.3568 13.7334 13.0222 12.5249 13.3247 11.7998C13.8086 12.3134 14.3833 12.3738 14.716 12.3134C14.2623 11.4674 14.4741 10.6215 14.6555 10.2891C15.1395 10.7423 15.8049 10.833 16.1679 10.7423C15.7142 10.1381 15.7142 8.59718 15.8352 8.05334C16.1376 8.26484 16.8333 8.47633 17.166 7.721C16.5914 7.53972 16.4704 5.54564 17.4988 5.57586ZM11.2376 5.75714C11.3284 5.6665 11.5099 5.51543 11.5703 5.60607C11.7216 5.81756 11.7518 5.96863 12.0241 6.24055C12.2055 6.42183 12.508 6.51247 12.6592 6.57289C12.7197 6.87503 12.145 7.29801 11.4796 6.69375C11.1469 6.3614 11.0259 5.96863 11.2376 5.75714ZM12.75 9.89635C12.0241 10.8934 11.3284 10.4402 11.3284 10.4402C11.3284 10.4402 10.5117 10.1381 10.9049 8.95974C10.3907 8.59718 10.5722 8.11377 10.7234 8.02313C10.7839 8.1742 10.8444 8.47633 11.2981 8.71804C11.7518 8.95974 11.9333 8.80868 11.9636 8.71804C12.0543 8.53676 11.8426 8.35548 11.6611 8.20441C11.5099 8.02313 11.4796 7.75121 11.5703 7.63036C11.7216 7.44908 11.9636 7.47929 12.0845 7.56993C11.5401 7.66057 12.266 8.11377 12.4173 8.20441C12.5987 8.29505 13.3852 8.59718 13.1432 8.11377C13.2642 8.14398 13.4154 8.35548 13.3852 8.56697C13.3549 8.71804 13.1129 8.8691 12.871 8.83889C12.629 8.80868 12.3568 8.74825 12.266 8.92953C12.2055 9.02017 12.266 9.29209 12.7197 9.50358C13.1734 9.74529 13.3549 9.59422 13.5667 9.53379C13.6271 9.68486 13.3549 10.1078 12.75 9.89635ZM15.0488 7.66057C14.9883 7.9627 14.6253 8.08356 14.2018 7.99292C13.3247 7.81164 13.3247 7.14695 13.5969 7.02609C13.7179 7.11673 13.9599 7.29801 14.2018 7.32823C14.5648 7.38865 14.716 7.32823 14.958 7.32823C15.079 7.32823 15.079 7.53972 15.0488 7.66057Z" fill="#D70929"/>
        </svg>
  `;

  // 3) Swap: remove the old <a><img/></a>, insert the new <a><svg/></a>
  const oldAnchor = img.closest('a.navbar-brand-logo') || img;
  brandContainer.replaceChild(a, oldAnchor);
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Only target IMPORTANT callouts; add more types if needed.
  const sel = '.callout.callout-important .callout-title-container';

  document.querySelectorAll(sel).forEach(el => {
    // Prefer operating on the first text node
    const first = el.firstChild;
    const re = /^\s*(?:Important)\s*(?:&nbsp;|\u00A0|\s)?\d+(?:\.\d+)*\s*:\s*/i;

    if (first && first.nodeType === Node.TEXT_NODE) {
      first.textContent = first.textContent.replace(re, '');
    } else {
      // Fallback: operate on HTML if the first child isn't a text node
      el.innerHTML = el.innerHTML.replace(re, '');
    }
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const tools = document.querySelector('#quarto-header .quarto-navbar-tools');
  if (!tools) return;

  // Create the button
  const btn = document.createElement('button');
  btn.id = 'lecture-zoom-header-toggle';
  btn.className = 'btn-zoom-toggle';
  btn.type = 'button';
  btn.setAttribute('aria-pressed', 'false');
  btn.setAttribute('aria-label', 'Lecture zoom');
  btn.setAttribute('title', 'Lecture zoom (X)');

  // svg icon
  btn.innerHTML = `
    <!-- ENTER: four corners -->
    <svg class="icon-enter" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
        <path d="M3 9V3h6"/>
        <path d="M21 9V3h-6"/>
        <path d="M3 15v6h6"/>
        <path d="M21 15v6h-6"/>
    </svg>

    <!-- EXIT: corners-in (contract) -->
    <svg class="icon-exit" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
        <path d="M9 3v6H3"/>
        <path d="M15 3v6h6"/>
        <path d="M3 15h6v6"/>
        <path d="M21 15h-6v6"/>
    </svg>
  `;

  // Place it next to the colour-scheme toggle (after it, if present)
  const colorToggle = tools.querySelector('.quarto-color-scheme-toggle');
  if (colorToggle && colorToggle.parentNode) {
    colorToggle.parentNode.insertBefore(btn, colorToggle.nextSibling);
  } else {
    tools.appendChild(btn);
  }

  // Toggle logic
  const KEY = 'lecture-zoom-enabled';
  
  // Helper: are we in lecture zoom?
  const isLectureZoom = () =>
    document.body.classList.contains('lecture-zoom') ||
    document.documentElement.classList.contains('lecture-zoom');

  // Define closeLectureSearch early (forward declaration)
  let closeLectureSearch;

  const apply = (on) => {
    document.body.classList.toggle('lecture-zoom', on);
    document.documentElement.classList.toggle('lecture-zoom', on);
    btn.setAttribute('aria-pressed', on ? 'true' : 'false');
    
    // Close search overlay when exiting lecture zoom
    if (!on && closeLectureSearch) {
      closeLectureSearch();
    }
    
    // Nudge charts/layouts to recompute
    window.dispatchEvent(new Event('resize'));
    sessionStorage.setItem(KEY, on ? '1' : '0');
  };

  // Restore per-tab state
  apply(sessionStorage.getItem(KEY) === '1');

  // Click handler
  btn.addEventListener('click', () => apply(!isLectureZoom()));
  
  // Keyboard shortcut (Z)
  document.addEventListener('keydown', (e) => {
    if (e.key.toLowerCase() === 'x' && !/input|textarea|select/i.test(e.target.tagName)) {
      apply(!isLectureZoom());
    }
  });

  let acAnchor = null;          // where the autocomplete root came from
  let panelObserver = null;     // to catch newly created panels

  function ensureLectureOverlay() {
    let overlay = document.getElementById('lecture-search-overlay');
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.id = 'lecture-search-overlay';
      overlay.innerHTML = '<div class="lecture-search-modal"></div>';
      document.body.appendChild(overlay);

      // Close on backdrop click
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay && closeLectureSearch) closeLectureSearch();
      });

      // Close on Esc
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && closeLectureSearch) closeLectureSearch();
      });
    }
    return overlay;
  }

  function findAutocomplete() {
    const root =
      document.querySelector('.aa-Autocomplete') ||
      document.querySelector('.quarto-search .aa-Autocomplete') ||
      document.querySelector('.quarto-search-panel .aa-Autocomplete');

    const input = root?.querySelector('input.aa-Input');
    return { root, input };
  }

  // Move the results panel (if any) into the modal and normalize its positioning
  function reparentPanel(modal) {
    const panel = document.querySelector('.aa-Panel');
    if (!panel || modal.contains(panel)) return;
    modal.appendChild(panel);
    // Let CSS control layout/width; clear inline positioning from Algolia
    panel.style.left = '';
    panel.style.top = '';
    panel.style.width = '';
  }

  function startPanelObserver(modal) {
    if (panelObserver) return;
    panelObserver = new MutationObserver(() => reparentPanel(modal));
    // Listen on body, since Algolia often inserts the panel there
    panelObserver.observe(document.body, { childList: true, subtree: true });
  }

  function stopPanelObserver() {
    panelObserver?.disconnect();
    panelObserver = null;
  }

  function openLectureSearch() {
    if (!isLectureZoom()) return false;

    const { root, input } = findAutocomplete();
    if (!root || !input) return false;

    const overlay = ensureLectureOverlay();
    const modal = overlay.querySelector('.lecture-search-modal');

    // Anchor the current position of the autocomplete root (only once)
    if (!acAnchor) {
      acAnchor = document.createComment('autocomplete-anchor');
      root.parentNode.insertBefore(acAnchor, root);
    }

    // Move the autocomplete *root* into the modal
    modal.appendChild(root);

    // Ensure any results panel gets moved into the modal too
    reparentPanel(modal);
    startPanelObserver(modal);

    overlay.classList.add('open');
    document.documentElement.classList.add('search-open');

    // Focus the input after layout
    requestAnimationFrame(() => {
      input.focus();
      input.select?.();
      // In case Algolia computes sizes on resize, give it a nudge
      window.dispatchEvent(new Event('resize'));
    });

    return true;
  }

  // Now properly define closeLectureSearch
  closeLectureSearch = function() {
    const overlay = document.getElementById('lecture-search-overlay');
    if (!overlay || !overlay.classList.contains('open')) return;

    stopPanelObserver();

    const { root } = findAutocomplete();

    // Move panel (if currently inside modal) back to body to let Algolia clean up normally
    const modal = overlay.querySelector('.lecture-search-modal');
    const panel = modal?.querySelector('.aa-Panel');
    if (panel) document.body.appendChild(panel);

    // Put the autocomplete root back where it came from
    if (root && acAnchor && acAnchor.parentNode) {
      acAnchor.parentNode.insertBefore(root, acAnchor.nextSibling);
    }

    overlay.classList.remove('open');
    document.documentElement.classList.remove('search-open');
  };

  // Existing hotkeys:
  document.addEventListener('keydown', (e) => {
    const tag = e.target.tagName.toLowerCase();
    const typing = tag === 'input' || tag === 'textarea' || tag === 'select' || e.isComposing;
    if (typing) return;

    if (e.key === 'F' && e.shiftKey) {
      if (openLectureSearch()) {
        e.preventDefault();
        e.stopPropagation();
      }
    }
    if (e.key === 'Escape') {
      closeLectureSearch();
    }
  });

});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const tools = document.querySelector('#quarto-header .quarto-navbar-tools');
  if (!tools) return;

  // Create the print/save button
  const printBtn = document.createElement('button');
  printBtn.id = 'print-pdf-header-toggle';
  printBtn.className = 'btn-print-pdf';
  printBtn.type = 'button';
  printBtn.setAttribute('aria-label', 'Print or save as PDF');
  printBtn.setAttribute('title', 'Print/Save PDF (Ctrl+P)');

  // SVG icon (printer icon without control dot)
  printBtn.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <!-- Paper/document -->
      <path d="M6 9V2h12v7"/>
      <!-- Printer body -->
      <path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/>
      <!-- Output paper -->
      <rect x="6" y="14" width="12" height="8" rx="1"/>
    </svg>
  `;

  // Place it after the zoom button (if present) or color toggle
  const zoomToggle = tools.querySelector('#lecture-zoom-header-toggle');
  const colorToggle = tools.querySelector('.quarto-color-scheme-toggle');
  
  if (zoomToggle && zoomToggle.parentNode) {
    zoomToggle.parentNode.insertBefore(printBtn, zoomToggle.nextSibling);
  } else if (colorToggle && colorToggle.parentNode) {
    colorToggle.parentNode.insertBefore(printBtn, colorToggle.nextSibling);
  } else {
    tools.appendChild(printBtn);
  }

  // Helper function to expand all collapsible content
  const expandAllContent = () => {
    const expandedElements = [];

    // Quarto callout blocks with collapse
    document.querySelectorAll('.callout.collapse').forEach(callout => {
      if (!callout.classList.contains('show')) {
        callout.classList.add('show', 'printing-expanded');
        expandedElements.push(callout);
      }
    });

    // Details/summary elements
    document.querySelectorAll('details:not([open])').forEach(details => {
      details.setAttribute('open', '');
      details.classList.add('printing-expanded');
      expandedElements.push(details);
    });

    // Bootstrap collapse elements
    document.querySelectorAll('.collapse:not(.show)').forEach(collapse => {
      collapse.classList.add('show', 'printing-expanded');
      expandedElements.push(collapse);
    });

    // Quarto tabsets - show all tab content
    document.querySelectorAll('.tab-pane:not(.active)').forEach(tab => {
      tab.classList.add('active', 'show', 'printing-expanded');
      expandedElements.push(tab);
    });

    return expandedElements;
  };

  // Helper function to restore collapsed state
  const restoreCollapsedContent = (elements) => {
    elements.forEach(el => {
      if (el.classList.contains('printing-expanded')) {
        if (el.tagName === 'DETAILS') {
          el.removeAttribute('open');
        } else if (el.classList.contains('callout')) {
          el.classList.remove('show');
        } else if (el.classList.contains('collapse')) {
          el.classList.remove('show');
        } else if (el.classList.contains('tab-pane')) {
          el.classList.remove('active', 'show');
        }
        el.classList.remove('printing-expanded');
      }
    });
  };

  // Show print options dialog
  const showPrintDialog = () => {
    // Remove any existing dialog
    const existingDialog = document.getElementById('print-options-dialog');
    if (existingDialog) existingDialog.remove();

    // Get chapter list from sidebar
    const chapters = getChapterList();
    const currentChapter = getCurrentChapterInfo();

    const dialog = document.createElement('div');
    dialog.id = 'print-options-dialog';
    dialog.className = 'print-dialog-overlay';
    dialog.innerHTML = `
      <div class="print-dialog">
        <h3>Print Options</h3>
        
        <div class="print-option">
          <label>
            Print scope:
            <select id="print-scope">
              <option value="current">Current page only</option>
              <option value="chapter">Current chapter (${currentChapter.name})</option>
              <option value="part">Current part (${currentChapter.partName})</option>
              <option value="selected">Selected chapters...</option>
              <option value="all">Entire book</option>
            </select>
          </label>
        </div>

        <div class="print-option" id="chapter-selection" style="display: none;">
          <label>Select chapters to print:</label>
          <div class="chapter-list">
            ${chapters.map(ch => `
              <label class="chapter-item">
                <input type="checkbox" value="${ch.href}" data-title="${ch.title}">
                ${ch.part ? `<strong>${ch.part}</strong>` : ''} ${ch.title}
              </label>
            `).join('')}
          </div>
        </div>
        
        <div class="print-option">
          <label>
            <input type="checkbox" id="print-expand-all" checked>
            Expand all collapsed content
          </label>
        </div>
        
        <div class="print-option">
          <label>
            <input type="checkbox" id="print-page-numbers" checked>
            Add page numbers
          </label>
        </div>
        
        <div class="print-option">
          <label>
            <input type="checkbox" id="print-chapter-info" checked>
            Include chapter/section headers
          </label>
        </div>

        <div class="print-option">
          <label>
            Layout:
            <select id="print-layout">
              <option value="default">Default</option>
              <option value="compact">Compact (smaller margins)</option>
              <option value="wide">Wide (full width)</option>
            </select>
          </label>
        </div>
        
        <div class="print-progress" id="print-progress" style="display: none;">
          <div class="progress-bar">
            <div class="progress-fill"></div>
          </div>
          <div class="progress-text">Preparing pages...</div>
        </div>
        
        <div class="print-actions">
          <button class="btn-print-cancel">Cancel</button>
          <button class="btn-print-confirm">Print</button>
        </div>
      </div>
    `;

    document.body.appendChild(dialog);

    // Handle scope change
    const scopeSelect = dialog.querySelector('#print-scope');
    const chapterSelection = dialog.querySelector('#chapter-selection');
    
    scopeSelect.addEventListener('change', () => {
      chapterSelection.style.display = scopeSelect.value === 'selected' ? 'block' : 'none';
    });

    // Handle dialog actions
    const confirmBtn = dialog.querySelector('.btn-print-confirm');
    const cancelBtn = dialog.querySelector('.btn-print-cancel');

    confirmBtn.addEventListener('click', () => {
      const scope = dialog.querySelector('#print-scope').value;
      const options = {
        expandAll: dialog.querySelector('#print-expand-all').checked,
        pageNumbers: dialog.querySelector('#print-page-numbers').checked,
        chapterInfo: dialog.querySelector('#print-chapter-info').checked,
        layout: dialog.querySelector('#print-layout').value,
        scope: scope
      };
      
      // Get selected chapters if scope is 'selected'
      if (scope === 'selected') {
        options.chapters = Array.from(dialog.querySelectorAll('.chapter-item input:checked'))
          .map(cb => ({ href: cb.value, title: cb.dataset.title }));
      }
      
      dialog.remove();
      
      // Handle different scopes
      if (scope === 'current') {
        triggerPrint(options);
      } else {
        triggerMultiPagePrint(options);
      }
    });

    cancelBtn.addEventListener('click', () => {
      dialog.remove();
    });

    // Close on backdrop click
    dialog.addEventListener('click', (e) => {
      if (e.target === dialog) dialog.remove();
    });

    // Close on Escape
    const escHandler = (e) => {
      if (e.key === 'Escape') {
        dialog.remove();
        document.removeEventListener('keydown', escHandler);
      }
    };
    document.addEventListener('keydown', escHandler);
  };

  // Get chapter list from sidebar
  const getChapterList = () => {
    const chapters = [];
    const sidebar = document.querySelector('.sidebar-navigation');
    if (!sidebar) return chapters;
    
    let currentPart = '';
    sidebar.querySelectorAll('.sidebar-item').forEach(item => {
      if (item.querySelector('.sidebar-item-text')?.classList.contains('sidebar-part')) {
        currentPart = item.textContent.trim();
      } else if (item.querySelector('a')) {
        const link = item.querySelector('a');
        chapters.push({
          href: link.getAttribute('href'),
          title: link.textContent.trim(),
          part: currentPart,
          element: item
        });
      }
    });
    
    return chapters;
  };

  // Get current chapter info - FIXED version
  const getCurrentChapterInfo = () => {
    // Try to find the active sidebar item
    let active = document.querySelector('.sidebar-item.active a');
    if (!active) {
      // Fallback: check if we're on a chapter page
      const chapterTitle = document.querySelector('h1.chapter-title, .title')?.textContent?.trim();
      return { name: chapterTitle || 'Current Page', partName: 'No part' };
    }
    
    const title = active.textContent.trim();
    
    // Find part name by traversing up from the active item
    let partName = '';
    let currentEl = active.closest('.sidebar-item');
    
    // Go up through previous siblings until we find a part
    while (currentEl) {
      currentEl = currentEl.previousElementSibling;
      if (currentEl && currentEl.querySelector('.sidebar-part, .chapter-part')) {
        partName = currentEl.textContent.trim();
        break;
      }
    }
    
    // If not found, check parent sections
    if (!partName) {
      const parentSection = active.closest('.chapter-section');
      if (parentSection) {
        const partEl = parentSection.querySelector('.sidebar-part, .chapter-part');
        if (partEl) partName = partEl.textContent.trim();
      }
    }
    
    return { name: title, partName: partName || 'Main Content' };
  };

  // Get chapters for current part
  const getChaptersInPart = (partName) => {
    const chapters = getChapterList();
    const inPart = [];
    let foundPart = false;
    
    for (const ch of chapters) {
      if (ch.part === partName) {
        foundPart = true;
        inPart.push(ch);
      } else if (foundPart && ch.part !== partName) {
        break; // Moved to next part
      }
    }
    
    return inPart;
  };

  // Multi-page print handler
  const triggerMultiPagePrint = async (options) => {
    const progressEl = document.getElementById('print-progress');
    const progressBar = progressEl?.querySelector('.progress-fill');
    const progressText = progressEl?.querySelector('.progress-text');
    
    if (progressEl) progressEl.style.display = 'block';
    
    // Determine which chapters to print
    let chaptersToPrint = [];
    
    switch (options.scope) {
      case 'all':
        chaptersToPrint = getChapterList();
        break;
      case 'part':
        const currentInfo = getCurrentChapterInfo();
        chaptersToPrint = getChaptersInPart(currentInfo.partName);
        break;
      case 'chapter':
        // For current chapter, just use single page print
        triggerPrint(options);
        return;
      case 'selected':
        chaptersToPrint = options.chapters || [];
        break;
    }
    
    if (chaptersToPrint.length === 0) {
      alert('No chapters selected for printing');
      return;
    }
    
    // Create iframe for loading pages
    const iframe = document.createElement('iframe');
    iframe.style.position = 'absolute';
    iframe.style.left = '-9999px';
    iframe.style.width = '1000px';
    iframe.style.height = '1000px';
    document.body.appendChild(iframe);
    
    // Collect all pages
    const printPages = [];
    
    for (let i = 0; i < chaptersToPrint.length; i++) {
      const chapter = chaptersToPrint[i];
      const progress = ((i + 1) / chaptersToPrint.length) * 100;
      
      if (progressBar) progressBar.style.width = progress + '%';
      if (progressText) progressText.textContent = `Loading ${chapter.title}...`;
      
      try {
        // Load page in iframe
        const pageContent = await loadPageInIframe(iframe, chapter.href);
        
        // Process the page
        if (options.expandAll) {
          expandAllContentInDocument(iframe.contentDocument);
        }
        
        // Extract and store the content
        const content = iframe.contentDocument.querySelector('.content, main, article')?.innerHTML || '';
        printPages.push({
          title: chapter.title,
          content: content
        });
        
      } catch (err) {
        console.error(`Failed to load ${chapter.title}:`, err);
      }
    }
    
    // Clean up
    iframe.remove();
    if (progressEl) progressEl.style.display = 'none';
    
    // Create combined print document
    createCombinedPrintDocument(printPages, options);
  };

  // Load page in iframe
  const loadPageInIframe = (iframe, href) => {
    return new Promise((resolve, reject) => {
      const timeout = setTimeout(() => {
        reject(new Error('Page load timeout'));
      }, 10000);
      
      iframe.onload = () => {
        clearTimeout(timeout);
        // Wait a bit for JS to run
        setTimeout(() => resolve(iframe.contentDocument), 500);
      };
      
      iframe.src = href;
    });
  };

  // Expand content in a document
  const expandAllContentInDocument = (doc) => {
    // Quarto callout blocks
    doc.querySelectorAll('.callout.collapse').forEach(callout => {
      callout.classList.add('show');
    });

    // Details elements
    doc.querySelectorAll('details').forEach(details => {
      details.setAttribute('open', '');
    });

    // Bootstrap collapse
    doc.querySelectorAll('.collapse').forEach(collapse => {
      collapse.classList.add('show');
    });
  };

  // Create combined document for printing - FIXED version
  const createCombinedPrintDocument = (pages, options) => {
    // Create new window for printing
    const printWindow = window.open('', '_blank');
    
    // Collect all stylesheets except those that might interfere
    const stylesheets = Array.from(document.querySelectorAll('link[rel="stylesheet"]'))
      .filter(link => !link.href.includes('quarto-html'))
      .map(link => link.outerHTML).join('\n');
    
    // Build HTML
    const html = `
      <!DOCTYPE html>
      <html class="${document.documentElement.className}">
      <head>
        <meta charset="UTF-8">
        <title>MAS2901 Statistical Inference - Print</title>
        ${stylesheets}
        <style>
          /* Reset background for light mode printing */
          @media print {
            body:not(.quarto-dark) {
              background-color: white !important;
              color: black !important;
            }
            
            body:not(.quarto-dark) .content,
            body:not(.quarto-dark) .quarto-container-default,
            body:not(.quarto-dark) main,
            body:not(.quarto-dark) article {
              background-color: white !important;
              color: black !important;
            }
            
            /* Fix math rendering in dark mode */
            .quarto-dark .katex,
            .quarto-dark .MathJax,
            .quarto-dark .MathJax *,
            .quarto-dark .katex * {
              color: #e9ecef !important;
              background-color: transparent !important;
              fill: #e9ecef !important;
            }
            
            /* Ensure OJS figures fit within page */
            .ojs-cell,
            .cell-output-display,
            figure,
            .figure {
              max-width: 100% !important;
              overflow: hidden !important;
              page-break-inside: avoid;
            }
            
            .ojs-cell svg,
            figure svg,
            .cell-output-display svg {
              max-width: 100% !important;
              height: auto !important;
            }
            
            /* Scale down large images/plots */
            img, svg {
              max-width: 100% !important;
              height: auto !important;
            }
            
            /* Hide overflow indicators */
            * {
              overflow: visible !important;
            }
            
            pre {
              overflow-wrap: break-word !important;
              white-space: pre-wrap !important;
            }
            
            /* Page breaks */
            .chapter-break { 
              page-break-before: always;
              margin-top: 0 !important;
            }
            
            /* Remove section headers that duplicate */
            .sidebar-title,
            .navbar-title,
            .quarto-title-meta {
              display: none !important;
            }
            
            /* Compact layout adjustments */
            body.print-layout-compact {
              font-size: 10pt;
              line-height: 1.4;
            }
            
            body.print-layout-compact h1 { font-size: 1.4em; }
            body.print-layout-compact h2 { font-size: 1.2em; }
            body.print-layout-compact h3 { font-size: 1.1em; }
            
            /* Wide layout */
            body.print-layout-wide .content {
              max-width: 100% !important;
              margin: 0.5in !important;
            }
            
            /* Hide navigation elements */
            .quarto-title-breadcrumbs,
            .page-navigation,
            .nav-footer {
              display: none !important;
            }
          }
          
          /* Dark mode specific fixes */
          ${document.body.classList.contains('quarto-dark') ? `
          html, body {
            background-color: #1a1a1a !important;
            color: #e9ecef !important;
          }
          ` : ''}
        </style>
      </head>
      <body class="${document.body.className} printing print-layout-${options.layout} ${options.pageNumbers ? 'print-page-numbers' : ''} ${options.chapterInfo ? 'print-chapter-info' : ''}">
        ${pages.map((page, i) => `
          <div class="${i > 0 ? 'chapter-break' : ''}">
            <h1 class="chapter-title">${page.title}</h1>
            ${page.content}
          </div>
        `).join('\n')}
      </body>
      </html>
    `;
    
    printWindow.document.write(html);
    printWindow.document.close();
    
    // Wait for content to render
    printWindow.onload = () => {
      setTimeout(() => {
        // Final cleanup before printing
        const doc = printWindow.document;
        
        // Remove duplicate headers
        doc.querySelectorAll('.quarto-title, .title-block-banner').forEach((el, idx) => {
          if (idx > 0) el.remove();
        });
        
        // Scale OJS content
        doc.querySelectorAll('.ojs-cell').forEach(cell => {
          cell.style.maxWidth = '100%';
          cell.style.overflow = 'hidden';
        });
        
        printWindow.print();
        
        // Close after print dialog
        printWindow.onafterprint = () => {
          printWindow.close();
        };
      }, 1000); // Give more time for math to render
    };
  };

  // Print handler with options
  const triggerPrint = (options) => {
    let expandedElements = [];
    
    // Apply print classes based on options
    document.body.classList.add('printing');
    if (options.pageNumbers) document.body.classList.add('print-page-numbers');
    if (options.chapterInfo) document.body.classList.add('print-chapter-info');
    document.body.classList.add(`print-layout-${options.layout}`);
    
    // Store chapter/section info
    const chapterTitle = document.querySelector('h1.title')?.textContent || '';
    const courseTitle = 'MAS2901 Statistical Inference';
    document.body.setAttribute('data-chapter-title', chapterTitle);
    document.body.setAttribute('data-course-title', courseTitle);
    
    // Force dark mode styles to be applied to documentElement too
    if (document.body.classList.contains('quarto-dark')) {
      document.documentElement.classList.add('printing-dark');
    }
    
    // Expand content if requested
    if (options.expandAll) {
      expandedElements = expandAllContent();
    }
    
    // Small delay to ensure DOM updates
    setTimeout(() => {
      window.print();
      
      // Clean up after print dialog closes
      window.addEventListener('afterprint', function cleanup() {
        document.body.classList.remove('printing', 'print-page-numbers', 
          'print-chapter-info', `print-layout-${options.layout}`);
        document.documentElement.classList.remove('printing-dark');
        
        // Restore collapsed state
        if (expandedElements.length > 0) {
          restoreCollapsedContent(expandedElements);
        }
        
        window.removeEventListener('afterprint', cleanup);
      });
    }, 100);
  };

  // Click handler - show options dialog
  printBtn.addEventListener('click', () => {
    showPrintDialog();
  });
  
  // Direct print shortcut (Ctrl+Shift+P) - use default options
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'p' && 
        !/input|textarea|select/i.test(e.target.tagName)) {
      e.preventDefault();
      showPrintDialog();
    }
  });
});
</script>

<style>
/* Button styling to match other header buttons */
.btn-print-pdf {
  background: none;
  border: none;
  cursor: pointer;
  padding: 0.375rem;
  margin: 0 0.25rem;
  border-radius: 0.25rem;
  color: var(--bs-navbar-color, #333);
  transition: opacity 0.15s ease-in-out;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.btn-print-pdf:hover {
  opacity: 0.7;
}

.btn-print-pdf svg {
  width: 1.2rem;
  height: 1.2rem;
}

/* Print options dialog */
.print-dialog-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.print-dialog {
  background: var(--bs-body-bg, white);
  color: var(--bs-body-color, black);
  padding: 2rem;
  border-radius: 0.5rem;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
}

.print-dialog h3 {
  margin: 0 0 1.5rem 0;
  font-size: 1.25rem;
}

.print-option {
  margin-bottom: 1rem;
}

.print-option label {
  display: flex;
  align-items: center;
  cursor: pointer;
  user-select: none;
}

.print-option input[type="checkbox"] {
  margin-right: 0.5rem;
}

.print-option select {
  margin-left: 0.5rem;
  padding: 0.25rem 0.5rem;
  border: 1px solid var(--bs-border-color, #ddd);
  border-radius: 0.25rem;
  background: var(--bs-body-bg, white);
  color: var(--bs-body-color, black);
}

/* Chapter selection list */
.chapter-list {
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid var(--bs-border-color, #ddd);
  border-radius: 0.25rem;
  padding: 0.5rem;
  margin-top: 0.5rem;
}

.chapter-item {
  display: block;
  padding: 0.25rem 0;
  margin: 0;
}

.chapter-item input {
  margin-right: 0.5rem;
}

/* Progress bar */
.print-progress {
  margin-top: 1rem;
}

.progress-bar {
  height: 20px;
  background: var(--bs-gray-200, #e9ecef);
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: 0.5rem;
}

.progress-fill {
  height: 100%;
  background: var(--bs-primary, #007bff);
  width: 0%;
  transition: width 0.3s ease;
}

.progress-text {
  text-align: center;
  font-size: 0.875rem;
  color: var(--bs-secondary, #6c757d);
}

.print-actions {
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
  margin-top: 1.5rem;
}

.print-actions button {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 0.25rem;
  cursor: pointer;
  font-size: 0.9rem;
}

.btn-print-confirm {
  background: var(--bs-primary, #007bff);
  color: white;
}

.btn-print-cancel {
  background: var(--bs-secondary, #6c757d);
  color: white;
}

.print-actions button:hover {
  opacity: 0.9;
}

/* Dark mode support */
.quarto-dark .btn-print-pdf {
  color: var(--bs-navbar-dark-color, #fff);
}

  /* Print-specific styles */
@media print {
  /* Hide UI elements */
  #quarto-header,
  #quarto-sidebar,
  .quarto-navbar,
  .btn-print-pdf,
  .btn-zoom-toggle,
  .quarto-color-scheme-toggle,
  .print-dialog-overlay,
  .ink-tool-container,
  #ink-canvas-container,
  #inkpad-canvas,
  .inkpad-toolbar {
    display: none !important;
  }
  
  /* Force background colors and proper color adjustments */
  * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
  
  /* Light mode: force pure white background */
  body:not(.quarto-dark),
  body:not(.quarto-dark) .content,
  body:not(.quarto-dark) .quarto-container-default,
  body:not(.quarto-dark) main,
  body:not(.quarto-dark) article,
  body:not(.quarto-dark) pre,
  body:not(.quarto-dark) code {
    background-color: white !important;
    background: white !important;
  }
  
  /* Apply dark mode to both html and body for first page fix */
  html.printing-dark,
  html.printing-dark body,
  .quarto-dark,
  .quarto-dark body {
    background-color: #1a1a1a !important;
    color: #e9ecef !important;
  }
  
  /* Ensure the root and all containers have dark background */
  html.printing-dark *,
  .quarto-dark * {
    background-color: inherit;
    color: inherit;
  }
  
  /* Specific dark mode overrides */
  html.printing-dark .content,
  html.printing-dark .quarto-container-default,
  html.printing-dark main,
  html.printing-dark article,
  .quarto-dark .content,
  .quarto-dark .quarto-container-default,
  .quarto-dark main,
  .quarto-dark article {
    background-color: #1a1a1a !important;
    color: #e9ecef !important;
  }
  
  /* Dark mode code blocks */
  html.printing-dark pre,
  html.printing-dark code,
  .quarto-dark pre,
  .quarto-dark code {
    background-color: #2d2d2d !important;
    color: #e9ecef !important;
    border-color: #444 !important;
  }
  
  /* Fix math rendering - remove backgrounds */
  .katex,
  .MathJax,
  .katex *,
  .MathJax *,
  .MathJax_Display,
  .MathJax_Preview,
  mjx-container,
  mjx-container *,
  .katex-display,
  .katex-html {
    background-color: transparent !important;
    background: transparent !important;
  }
  
  /* Dark mode math text color */
  .quarto-dark .katex,
  .quarto-dark .MathJax,
  .quarto-dark mjx-container,
  html.printing-dark .katex,
  html.printing-dark .MathJax,
  html.printing-dark mjx-container {
    color: #e9ecef !important;
  }
  
  /* OJS and figure scaling */
  .ojs-cell,
  .cell-output-display,
  .cell-output,
  .figure,
  figure {
    max-width: 100% !important;
    width: auto !important;
    overflow: visible !important;
    page-break-inside: avoid;
  }
  
  .ojs-cell > *,
  .cell-output-display > * {
    max-width: 100% !important;
  }
  
  /* Scale SVGs and images */
  svg, img {
    max-width: 100% !important;
    height: auto !important;
    width: auto !important;
    display: block;
  }
  
  /* Handle wide tables */
  table {
    font-size: 0.9em;
    max-width: 100% !important;
  }
  
  .table-responsive {
    overflow: visible !important;
  }
  
  /* Code blocks shouldn't overflow */
  pre {
    max-width: 100% !important;
    overflow-wrap: break-word !important;
    white-space: pre-wrap !important;
    word-break: break-word !important;
  }
  
  /* Dark mode callouts */
  html.printing-dark .callout,
  .quarto-dark .callout {
    background-color: #2d2d2d !important;
    border: 1px solid #444 !important;
    color: #e9ecef !important;
  }
  
  html.printing-dark .callout-title,
  .quarto-dark .callout-title {
    color: #e9ecef !important;
  }
  
  /* Dark mode tables */
  html.printing-dark table,
  .quarto-dark table {
    background-color: transparent !important;
    color: #e9ecef !important;
  }
  
  html.printing-dark th,
  .quarto-dark th {
    background-color: #2d2d2d !important;
    border-color: #444 !important;
  }
  
  html.printing-dark td,
  .quarto-dark td {
    background-color: transparent !important;
    border-color: #444 !important;
  }
  
  /* Dark mode links */
  html.printing-dark a,
  .quarto-dark a {
    color: #66b3ff !important;
  }
  
  /* Page setup with dark background */
  @page {
    margin: 0.75in;
    size: letter;
    
    @bottom-right {
      content: counter(page);
    }
  }
  
  /* First page specific fix */
  @page :first {
    margin-top: 0.5in;
  }
  
  /* Default layout */
  .quarto-container-default {
    max-width: 100% !important;
    padding: 0 !important;
  }
  
  /* Compact layout */
  body.print-layout-compact {
    font-size: 10pt;
  }
  
  body.print-layout-compact .content {
    margin: 0.5in !important;
  }
  
  /* Wide layout */
  body.print-layout-wide .content {
    margin: 0.25in !important;
  }
  
  /* Force expanded content to show as expanded */
  .printing-expanded.callout.collapse,
  .printing-expanded.collapse {
    display: block !important;
  }
  
  /* Tab content - show with headers */
  body.printing .tab-pane.printing-expanded {
    display: block !important;
    border-top: 1px solid #ddd;
    padding-top: 1rem;
    margin-top: 1rem;
  }
  
  html.printing-dark .tab-pane.printing-expanded,
  .quarto-dark.printing .tab-pane.printing-expanded {
    border-top-color: #444 !important;
  }
  
  body.printing .tab-pane.printing-expanded::before {
    content: attr(aria-labelledby);
    font-weight: bold;
    display: block;
    margin-bottom: 0.5rem;
  }
  
  /* Page numbers */
  body.print-page-numbers {
    counter-reset: page;
  }
  
  /* Chapter info header */
  body.print-chapter-info::before {
    content: attr(data-course-title) " - " attr(data-chapter-title);
    position: fixed;
    top: 0;
    right: 0;
    font-size: 10pt;
    color: #666;
    padding: 0.5rem;
    z-index: 10000;
    background-color: transparent !important;
  }
  
  html.printing-dark .print-chapter-info::before,
  .quarto-dark.print-chapter-info::before {
    color: #aaa !important;
  }
  
  /* Page breaks */
  .chapter, h1, h2 {
    page-break-before: auto;
    page-break-after: avoid;
  }
  
  /* Avoid breaks inside elements */
  pre, blockquote, figure, .callout, table {
    page-break-inside: avoid;
  }
  
  /* Ensure callout styling prints well */
  .callout {
    border: 1px solid #ddd !important;
    padding: 0.5rem !important;
  }
  
  /* Mathematics in dark mode */
  html.printing-dark .katex,
  html.printing-dark .MathJax,
  .quarto-dark .katex,
  .quarto-dark .MathJax {
    color: #e9ecef !important;
  }
  
  /* Images and figures */
  html.printing-dark img,
  .quarto-dark img {
    opacity: 0.9;
  }
  
  /* Blockquotes */
  html.printing-dark blockquote,
  .quarto-dark blockquote {
    border-left-color: #444 !important;
    color: #adb5bd !important;
    background-color: transparent !important;
  }
}
</style>
<style>


  .inkpad-toolbar:not(.open){ display:none !important; }
  .inkpad-toolbar.open{ display:flex; }

  /* Ensure toolbar always clickable (and fast on touch) */
  .inkpad-toolbar{ pointer-events:auto; }
  .inkpad-btn{ touch-action:manipulation; user-select:none; }

  /* Nice visual cue when drawing */
  #inkpad-canvas.drawing { cursor: crosshair !important; }
  #quarto-content > #inkpad-canvas { padding-top: 0 !important; }

/* And make sure the canvas itself never has padding/margins */
  #inkpad-canvas { padding: 0 !important; margin: 0; display: block; box-sizing: content-box; }

  /* Floating toolbar */
  .inkpad-toolbar {
    position: fixed; z-index: 9999; right: 10px; bottom: 10px;
    gap: 4px; background: transparent;
    padding: 2px; border-radius: 8px;
  }
  .inkpad-btn {
    border: 0; border-radius: 10px; padding: 8px 10px; color: var(--brand-fg); cursor: pointer;
    background: var(--surface); font: 600 12px/1.1;
  }
  .inkpad-btn.active { background: var(--brand-teal); color: var(--brand-bg) }

  /* Icon sizing + swapping */
.inkpad-btn .inkpad-icon { width: 18px; height: 18px; display: block; }

/* Micro-interaction polish (respects currentColor / theme) */
.inkpad-btn .icon-pen { transition: transform .15s ease; }
.inkpad-btn:hover .icon-pen { transform: translateY(-1px) rotate(-8deg); }
@media (prefers-reduced-motion: reduce) {
  .inkpad-btn .icon-pen { transition: none; }
}

  /* Canvas overlay (document-sized, scrolls with page) */
#inkpad-canvas {
  position: fixed; 
  top: 0; 
  left: 0;
  z-index: 9998;
  touch-action: none;
  padding: 0 !important; 
  margin: 0; 
  display: block; 
  box-sizing: content-box;
  pointer-events: none; /* You're already toggling this in JS */
}

/*  Hide during print */
@media print {
  #inkpad-canvas {
    display: none !important;
    position: absolute !important; /* fallback */
    width: 0 !important;
    height: 0 !important;
  }
}


/* ----- Popover ----- */
.inkpad-popover {
  position: fixed;
  right: 10px;
  bottom: 56px;                /* sits just above the toolbar */
  z-index: 10000;
  display: none;
  padding: 10px;
  background: var(--surface);
  color: var(--brand-fg);
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,.22);
  width: 240px;
}

/* little arrow pointing to the toolbar */
.inkpad-popover::after {
  content: "";
  position: absolute;
  right: 18px;
  bottom: -8px;
  width: 14px; height: 14px;
  background: var(--surface);
  transform: rotate(45deg);
  box-shadow: 3px 3px 10px rgba(0,0,0,.12);
}

.inkpad-popover.open { display: block; }

.inkpad-field {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 10px;
}
.inkpad-field:last-child { margin-bottom: 0; }

.inkpad-field label {
  font: 600 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  color: var(--brand-fg);
}
.inkpad-out {
  font-weight: 700;
  color: var(--brand-teal);
}

/* ----- Color input (tidy circular swatch) ----- */
#inkpad-color {
  appearance: none;
  -webkit-appearance: none;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  padding: 0;
  border: 2px solid rgba(0,0,0,.15);
  background: transparent;
  cursor: pointer;
  overflow: hidden;
}
#inkpad-color::-webkit-color-swatch-wrapper { padding: 0; }
#inkpad-color::-webkit-color-swatch {
  border: none;
  border-radius: 50%;
}
#inkpad-color::-moz-color-swatch {
  border: none;
  border-radius: 50%;
}

/* ----- Range sliders (brand-styled, accessible) ----- */
#inkpad-size,
#inkpad-eraser-size {
  width: 100%;
  height: 28px;                 /* easier to grab on touch */
  background: transparent;
  cursor: pointer;
}

/* WebKit */
#inkpad-size::-webkit-slider-runnable-track,
#inkpad-eraser-size::-webkit-slider-runnable-track {
  height: 6px;
  background: linear-gradient(90deg, var(--brand-teal), var(--brand-teal)) 0/var(--_fill,0%) 100% no-repeat,
              color-mix(in oklab, var(--brand-fg) 10%, transparent);
  border-radius: 999px;
}
#inkpad-size::-webkit-slider-thumb,
#inkpad-eraser-size::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px; height: 18px;
  border-radius: 50%;
  background: var(--brand-bg);
  border: 2px solid var(--brand-teal);
  margin-top: -6px;            /* centers thumb on 6px track */
}

/* Firefox */
#inkpad-size::-moz-range-track,
#inkpad-eraser-size::-moz-range-track {
  height: 6px;
  background: color-mix(in oklab, var(--brand-fg) 10%, transparent);
  border-radius: 999px;
}
#inkpad-size::-moz-range-progress,
#inkpad-eraser-size::-moz-range-progress {
  height: 6px;
  background: var(--brand-teal);
  border-radius: 999px;
}
#inkpad-size::-moz-range-thumb,
#inkpad-eraser-size::-moz-range-thumb {
  width: 18px; height: 18px;
  border-radius: 50%;
  background: var(--brand-bg);
  border: 2px solid var(--brand-teal);
}

/* Improve focus ring for a11y */
#inkpad-color:focus-visible,
#inkpad-size:focus-visible,
#inkpad-eraser-size:focus-visible,
#inkpad-options:focus-visible {
  outline: 2px solid var(--brand-teal);
  outline-offset: 2px;
}


/* visually hidden helper */
.sr-only {
  position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden;
  clip:rect(0,0,0,0); white-space:nowrap; border:0;
}

/* icons inherit theme via currentColor */
.inkpad-icon { width: 18px; height: 18px; display: block; }

/* show/hide by state */
/* --- Toggle: icon swapping --- */
.inkpad-toggle .icon-pen { display: inline-block; }
.inkpad-toggle .icon-stop { display: none; }
.inkpad-toggle[aria-pressed="true"] .icon-pen { display: none; }
.inkpad-toggle[aria-pressed="true"] .icon-stop { display: inline-block; }

/* --- Toggle: visuals --- */
.inkpad-toggle {
  --ink-accent: var(--brand-red); /* customize if you like */
  --ink-off-border: color-mix(in oklab, var(--brand-fg) 28%, transparent);

  background: var(--brand-bg);
  color: var(--brand-fg);
  border: 1.5px solid var(--ink-off-border);
  padding: 6px 10px;
}

/* hover/focus when OFF */
.inkpad-toggle:hover {
  border-color: var(--brand-fg);
  background: color-mix(in oklab, var(--brand-bg) 90%, var(--brand-red));
}
.inkpad-toggle:focus-visible {
  outline: 2px solid var(--ink-accent);
  outline-offset: 2px;
}

/* ON state = â€œsolidâ€ */
.inkpad-toggle[aria-pressed="true"] {
  background: var(--ink-accent);
  border-color: var(--ink-accent);
  color: var(--brand-bg); /* makes icon stroke flip to readable */
}

/* Icon sizing + color via currentColor */
.inkpad-toggle .inkpad-icon {
  width: 16px; height: 16px;
  stroke: currentColor; /* override any inline stroke */
}

/* Subtle pen tilt only when OFF; never rotate the stop square */
.inkpad-toggle[aria-pressed="false"] .icon-pen {
  transform: rotate(-8deg) translateY(-1px);
}
.inkpad-toggle .icon-stop { transform: none !important; }




/* Mobile: turn the popover into a bottom sheet */
@media (max-width: 560px) {
  .inkpad-popover {
    right: 10px; left: 10px;
    bottom: 60px;
    width: auto;
  }
  .inkpad-popover::after { right: 24px; }
}

.inkpad-btn.active .inkpad-icon { transform: rotate(30deg); transition: transform .15s ease; }
.inkpad-btn .icon-stop { transform: none !important; }


/* Buttons: press/focus feedback + disabled state */
.inkpad-btn {
  transition: transform 120ms ease, box-shadow 160ms ease, background 160ms ease, opacity 120ms ease;
}
.inkpad-btn:active:not([disabled]) { transform: translateY(1px) scale(0.98); }
.inkpad-btn:focus-visible { outline: 2px solid var(--brand-red); outline-offset: 2px; }
.inkpad-btn[disabled] { opacity: .5; cursor: not-allowed; }

/* Quick flash ring when action fires */
.inkpad-btn.flash { box-shadow: 0 0 0 3px color-mix(in oklab, var(--brand-teal) 35%, transparent) inset; }
@media (prefers-reduced-motion: reduce) {
  .inkpad-btn { transition: none; }
}

/* Toast next to the toolbar */
.inkpad-toast {
  position: fixed; right: 12px; bottom: 56px; z-index: 10001;
  background: var(--surface); color: var(--brand-fg); border-radius: 10px;
  padding: 8px 10px; font: 600 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  box-shadow: 0 8px 24px rgba(0,0,0,.18);
  opacity: 0; transform: translateY(6px); pointer-events: none;
  transition: opacity 160ms ease, transform 160ms ease;
}
.inkpad-toast.show { opacity: 1; transform: translateY(0); }


/* --- Toggle icon swapping (put these LAST) --- */
#inkpad-toggle .inkpad-icon { display: none; }                /* hide both */
#inkpad-toggle[aria-pressed="false"] .icon-pen  { display: inline-block; }
#inkpad-toggle[aria-pressed="true"]  .icon-stop { display: inline-block; }




</style>

<div class="inkpad-toolbar" id="inkpad-toolbar" aria-label="Ink toolbar" aria-hidden="true">
<button class="inkpad-btn inkpad-toggle" id="inkpad-toggle" type="button" aria-pressed="false" title="Draw (D)" aria-label="Draw (D)">
  <span class="sr-only">Toggle ink</span>

  <!-- Start (Pen) -->
  <svg class="inkpad-icon icon-pen" viewbox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true">
    <path d="M3 21l3.5-1 9.9-9.9a2.8 2.8 0 0 0 0-4L15 3.7a2.8 2.8 0 0 0-4 0L1 13.7 0 18.5 3 21z"></path>
    <circle cx="12" cy="8.5" r="1"></circle>
    <path d="M13 20h8"></path>
  </svg>

  <!-- Stop (Square) -->
  <svg class="inkpad-icon icon-stop" viewbox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="3" aria-hidden="true">
    <rect x="6" y="6" width="12" height="12" rx="2"></rect>
  </svg>
</button>

  <button class="inkpad-btn active" id="inkpad-pen" type="button" title="Pen (P)">Pen</button>
  <button class="inkpad-btn" id="inkpad-eraser" type="button" title="Eraser (E)">Eraser</button>
  <button class="inkpad-btn" id="inkpad-undo" type="button" title="Undo (Z)">Undo</button>
  <button class="inkpad-btn" id="inkpad-clear" type="button" title="Clear">Clear</button>
  <button class="inkpad-btn" id="inkpad-save" type="button" title="Save PNG">Save</button>
  <button class="inkpad-btn" id="inkpad-options" type="button" title="Pen/Eraser options" aria-expanded="false">
    <svg class="inkpad-icon" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <!-- Feather "settings" glyph -->
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33
                1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51
                1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06
                a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09
                a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06
                a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9
                A1.65 1.65 0 0 0 10 3.09V3a2 2 0 1 1 4 0v.09
                a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06
                a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9
                c0 .66.39 1.27 1 1.51.16.06.33.09.51.09H21a2 2 0 1 1 0 4h-.09
                a1.65 1.65 0 0 0-1.51 1z"></path>
    </svg>
  </button>
</div>
<div id="inkpad-toast" class="inkpad-toast" role="status" aria-live="polite" aria-atomic="true"></div>


<!-- Popover container -->
<div id="inkpad-popover" class="inkpad-popover" aria-hidden="true">
  <div class="inkpad-field">
    <label for="inkpad-color">Pen colour</label>
    <input id="inkpad-color" type="color" value="#ff0055">
  </div>

  <div class="inkpad-field">
    <label for="inkpad-size">
      Pen size <span class="inkpad-out" id="inkpad-size-out">3</span>px
    </label>
    <input id="inkpad-size" type="range" min="1" max="30" step="0.2" value="3">
  </div>

  <div class="inkpad-field">
    <label for="inkpad-eraser-size">
      Eraser size <span class="inkpad-out" id="inkpad-eraser-size-out">12</span>px
    </label>
    <input id="inkpad-eraser-size" type="range" min="5" max="100" step="1" value="24">
  </div>
</div>

<canvas id="inkpad-canvas" aria-hidden="true"></canvas>

<script>
(() => {
  const canvas = document.getElementById('inkpad-canvas');
  const tb = (id) => document.getElementById(id);
  const toolbar = document.getElementById('inkpad-toolbar');
  const key = 'ink:' + location.pathname; // per-page storage key
  const ctx = canvas.getContext('2d');
  let drawingEnabled = false;
  let tool = 'pen'; // 'pen' | 'eraser'
  let penColor   = '#ff0055';
  let penSize    = 3;
  let eraserSize = 12;  // in CSS px
  let strokes = []; // array of {tool, color, size, points:[{x,y,p}]}
  let current = null;
  const baseSize = 3; // base pen size in CSS px


const toastEl = document.getElementById('inkpad-toast');
const undoBtn  = tb('inkpad-undo');
const clearBtn = tb('inkpad-clear');
const saveBtn  = tb('inkpad-save');

function flash(el) {
  if (!el) return;
  el.classList.add('flash');
  setTimeout(() => el.classList.remove('flash'), 180);
}

function showToast(msg, ms = 900) {
  if (!toastEl) return;
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  clearTimeout(showToast._t);
  showToast._t = setTimeout(() => toastEl.classList.remove('show'), ms);
}

// enable/disable actions based on whether there is anything to operate on
function hasInk() {
  return strokes.length > 0 || (current && current.points && current.points.length);
}
function updateActionStates() {
  const enabled = !!hasInk();
  if (undoBtn)  undoBtn.disabled  = !enabled;
  if (clearBtn) clearBtn.disabled = !enabled;
  if (saveBtn)  saveBtn.disabled  = !enabled;
}


  function onButton(id, fn){
    const el = tb(id);
    if(!el) return;
    el.addEventListener('click', (e)=>{
      e.preventDefault();
      e.stopPropagation();
      fn(e);
    }, {passive:false});
  }

// Popover toggle (pure toggle â€” no outside-click close)
const optionsBtn = document.getElementById('inkpad-options');
const popover    = document.getElementById('inkpad-popover');

if (optionsBtn && popover) {
  const setPopover = (open) => {
    popover.classList.toggle('open', open);
    popover.setAttribute('aria-hidden', String(!open));
    optionsBtn.setAttribute('aria-expanded', String(open));
    optionsBtn.classList.toggle('active', open);
  };

  optionsBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    setPopover(!popover.classList.contains('open'));
  });

  // Optional: keep clicks inside from bubbling (not required, but harmless)
  popover.addEventListener('click', (e) => e.stopPropagation());
}

function setPopover(open) {
  popover.classList.toggle('open', open);
  popover.setAttribute('aria-hidden', String(!open));
  optionsBtn.setAttribute('aria-expanded', String(open));
  optionsBtn.classList.toggle('active', open);
}

popover.addEventListener('click', (e) => e.stopPropagation());


  // read a CSS var once (for ring color); fallback if missing
  const brandTeal = (getComputedStyle(document.documentElement)
    .getPropertyValue('--brand-teal') || '').trim() || '#00c8ff';

   // live eraser preview in PAGE coords (CSS px)
  let hoverPage = null;  // {x, y} or null

  function drawEraserPreview() {
    if (!drawingEnabled || tool !== 'eraser' || !hoverPage) return;

    const r = eraserSize / 2;
    ctx.save();
    // we're already in page space (you set a -scroll transform in redraw)
    ctx.globalCompositeOperation = 'source-over';
    ctx.lineWidth = 1;
    // subtle fill + ring; alpha keeps it unobtrusive
    ctx.fillStyle   = 'rgba(0,0,0,0.06)';                // soft shadow fill
    ctx.strokeStyle = brandTeal;                         // themed ring
    ctx.beginPath();
    ctx.arc(hoverPage.x, hoverPage.y, r, 0, Math.PI * 2);
    ctx.fill();
    ctx.stroke();
    ctx.restore();
  }

  const colorInput  = document.getElementById('inkpad-color');
  const sizeInput   = document.getElementById('inkpad-size');
  const eraserInput = document.getElementById('inkpad-eraser-size');

  if (colorInput) {
    colorInput.addEventListener('input', e => { penColor = e.target.value; });
  }
  if (sizeInput) {
    sizeInput.addEventListener('input', e => { penSize = +e.target.value; });
  }
  if (eraserInput) {
    eraserInput.addEventListener('input', e => { eraserSize = +e.target.value; });
  }

  // --- slider outputs + track fill ---
  const sizeOut    = document.getElementById('inkpad-size-out');
  const eraserOut  = document.getElementById('inkpad-eraser-size-out');

  function setRangeFill(el) {
    const min = +el.min || 0, max = +el.max || 100, val = +el.value || 0;
    const pct = Math.max(0, Math.min(100, ((val - min) / (max - min)) * 100));
    el.style.setProperty('--_fill', pct + '%');   // used by your CSS gradient
  }

  // initial sync
  if (sizeOut)   sizeOut.textContent   = String(penSize);
  if (eraserOut) eraserOut.textContent = String(eraserSize);
  if (sizeInput)   setRangeFill(sizeInput);
  if (eraserInput) setRangeFill(eraserInput);

  // live updates
  if (sizeInput) {
    sizeInput.addEventListener('input', e => {
        penSize = +e.target.value;
        if (sizeOut) sizeOut.textContent = String(penSize);
        setRangeFill(sizeInput);
    });
  }
  if (eraserInput) {
    eraserInput.addEventListener('input', e => {
        eraserSize = +e.target.value;
        if (eraserOut) eraserOut.textContent = String(eraserSize);
        setRangeFill(eraserInput);
    });
  }

  // Size canvas to the full scrollable document (not just the viewport)
  function docSize() {
    const d = document.documentElement, b = document.body;
    const w = Math.max(d.scrollWidth,  b ? b.scrollWidth  : 0, d.clientWidth);
    const h = Math.max(d.scrollHeight, b ? b.scrollHeight : 0, d.clientHeight);
    return {w: Math.ceil(w), h: Math.ceil(h)};
  }

  function fitCanvas() {
    const dpr = currentDpr();
    const w = window.innerWidth;
    const h = window.innerHeight;

    canvas.width  = Math.ceil(w * dpr);
    canvas.height = Math.ceil(h * dpr);
    canvas.style.width  = w + 'px';
    canvas.style.height = h + 'px';

    // Set transform in redraw().
    scheduleRedraw();
  }

  // Re-measure shortly after load to catch late reflows (math/images)
  setTimeout(fitCanvas, 500);


  // save only serializable fields
  function save(){
    try {
        const lean = strokes.map(({anchorId, tool, color, size, points}) => ({anchorId, tool, color, size, points}));
        localStorage.setItem(key, JSON.stringify(lean));
    } catch {}
  }

  function load(){
    try {
        const s = localStorage.getItem(key);
        strokes = s ? (JSON.parse(s) || []) : [];
        for (const st of strokes) recomputeMeta(st);
    } catch { strokes = []; }
  }

function redraw(){
  const dpr = currentDpr();
  const sx = window.scrollX, sy = window.scrollY;

  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.setTransform(dpr, 0, 0, dpr, -sx * dpr, -sy * dpr);

  const vx0 = sx, vy0 = sy, vx1 = sx + window.innerWidth, vy1 = sy + window.innerHeight;

  // cache anchor offsets this frame
  const anchorCache = new Map();
  const infoFor = (id) => {
    if (!anchorCache.has(id)) anchorCache.set(id, anchorInfo(id));
    return anchorCache.get(id);
  };

  for (const s of strokes) {
    const info = infoFor(s.anchorId || 'global');
    if (!info.visible) continue;
    const B = s.localBBox;
    const absBox = { x0: B.x0 + info.left, y0: B.y0 + info.top, x1: B.x1 + info.left, y1: B.y1 + info.top };
    if (intersects(absBox, vx0, vy0, vx1, vy1)) drawStrokeAnchored(s, info);
  }
  if (current) {
    const info = infoFor(current.anchorId || 'global');
    if (info.visible) drawStrokeAnchored(current, info);
  }

  // draw the eraser halo on top
  drawEraserPreview();
}


  function styleFor(stroke){
    if (stroke.tool === 'eraser') {
        ctx.globalCompositeOperation = 'destination-out';
        ctx.strokeStyle = '#000';
        ctx.lineWidth = stroke.size; // â† eraserSize already baked in
    } else if (stroke.tool === 'highlight') {
        ctx.globalCompositeOperation = 'multiply';
        ctx.strokeStyle = (stroke.color || '#ff0') + '33';
        ctx.lineWidth = stroke.size * 2;
    } else {
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = stroke.color || penColor;
        ctx.lineWidth = stroke.size;
    }
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
  }

function drawStrokeAnchored(stroke, info){
  ctx.save();
  styleFor(stroke);
  ctx.translate(info.left, info.top);

  if (stroke._isDot) {
    // Draw like the live case so sizes match
    const r = (stroke.size || 3) / 2;
    const p = stroke.points[0];
    ctx.beginPath();
    ctx.arc(p.x, p.y, Math.max(1, r), 0, Math.PI*2);
    ctx.fillStyle = (stroke.tool === 'eraser') ? '#000' : ctx.strokeStyle;
    ctx.fill();
  } else if (stroke._localPath) {
    ctx.stroke(stroke._localPath);
  } else {
    // (your existing multi-point fallback)
    const pts = stroke.points || [];
    if (!pts.length) { ctx.restore(); return; }
    if (pts.length === 1) {
      const r = ctx.lineWidth/2;
      ctx.beginPath(); ctx.arc(pts[0].x, pts[0].y, Math.max(1,r), 0, Math.PI*2);
      ctx.fillStyle = (stroke.tool==='eraser') ? '#000' : ctx.strokeStyle;
      ctx.fill();
    } else {
      ctx.beginPath();
      ctx.moveTo(pts[0].x, pts[0].y);
      for (let i=1;i<pts.length-1;i++){
        const c=pts[i], n=pts[i+1];
        ctx.quadraticCurveTo(c.x, c.y, (c.x+n.x)/2, (c.y+n.y)/2);
      }
      const last = pts[pts.length-1];
      ctx.lineTo(last.x, last.y);
      ctx.stroke();
    }
  }

  ctx.restore();
}



function setDrawing(enabled){
  drawingEnabled = enabled;
  canvas.style.pointerEvents = enabled ? 'auto' : 'none';
  canvas.classList.toggle('drawing', enabled);

  const drawBtn = tb('inkpad-toggle');
  drawBtn.classList.toggle('active', enabled);
  drawBtn.setAttribute('aria-pressed', String(enabled));

  const label = enabled ? 'Stop drawing (D)' : 'Draw (D)';
  drawBtn.setAttribute('title', label);
  drawBtn.setAttribute('aria-label', label);

  if (!enabled) hoverPage = null;          
  scheduleRedraw();
}

  function setTool(t){
    tool = t;
    tb('inkpad-pen').classList.toggle('active', t==='pen');
    tb('inkpad-eraser').classList.toggle('active', t==='eraser');
  }

  // performance: cap dpr to avoid excessive sizes on high-dpi screens
  const DPR_CAP = 1.5;                           // tune if you like
  function currentDpr(){ return Math.min(window.devicePixelRatio || 1, DPR_CAP); }

  // Throttle redraws to once per frame
  let raf = 0;
  function scheduleRedraw(){
    if (raf) return;
    raf = requestAnimationFrame(() => { raf = 0; redraw(); });
  }

  function buildPath2DLocal(stroke){
    const pts = stroke.points || [];
    const path = new Path2D();
    if (!pts.length) return path;
    if (pts.length === 1) {
        const size = stroke.size || 3;
        path.arc(pts[0].x, pts[0].y, Math.max(1, size/2), 0, Math.PI*2);
        return path;
    }
    path.moveTo(pts[0].x, pts[0].y);
    for (let i=1; i<pts.length-1; i++){
        const c = pts[i], n = pts[i+1];
        path.quadraticCurveTo(c.x, c.y, (c.x+n.x)/2, (c.y+n.y)/2);
    }
    const last = pts[pts.length-1];
    path.lineTo(last.x, last.y);
    return path;
  }


function recomputeMeta(s){
  if (!s.points?.length) return;

  let b = {x0:s.points[0].x,y0:s.points[0].y,x1:s.points[0].x,y1:s.points[0].y};
  for (const p of s.points){ if (p.x<b.x0) b.x0=p.x; if (p.y<b.y0) b.y0=p.y; if (p.x>b.x1) b.x1=p.x; if (p.y>b.y1) b.y1=p.y; }

  // mark single-point strokes as dots and expand bbox by radius
  if (s.points.length === 1) {
    s._isDot = true;                      // non-serializable flag is fine
    const pad = (s.size || 3) / 2;
    b.x0 -= pad; b.y0 -= pad; b.x1 += pad; b.y1 += pad;
  } else {
    s._isDot = false;
  }

  s.localBBox = b;

  // cache path only for multi-point strokes
  if (!s._isDot) {
    Object.defineProperty(s, '_localPath', { value: buildPath2DLocal(s), enumerable: false, writable: true });
  } else {
    Object.defineProperty(s, '_localPath', { value: null, enumerable: false, writable: true });
  }
}


  function pushPointDecimated(arr, p, minDist=0.75){ // CSS px
    const last = arr[arr.length-1];
    if (!last) { arr.push(p); return true; }
    const dx = p.x - last.x, dy = p.y - last.y;
    if (dx*dx + dy*dy < minDist*minDist) return false;
    arr.push(p); return true;
  }
  function expandBBox(b, p){
    b.x0 = Math.min(b.x0, p.x); b.y0 = Math.min(b.y0, p.y);
    b.x1 = Math.max(b.x1, p.x); b.y1 = Math.max(b.y1, p.y);
  }
  function newBBox(p){ return {x0:p.x, y0:p.y, x1:p.x, y1:p.y}; }
  function intersects(b, x0,y0,x1,y1){ return !(b.x1 < x0 || b.x0 > x1 || b.y1 < y0 || b.y0 > y1); }


  function getAnchorAtPoint(clientX, clientY) {
    // Temporarily let the page receive the hit
    const prev = canvas.style.pointerEvents;
    canvas.style.pointerEvents = 'none';
    const hit = document.elementFromPoint(clientX, clientY);
    canvas.style.pointerEvents = prev || (drawingEnabled ? 'auto' : 'none');

    const el = hit?.closest('details, .collapse, .callout, [data-ink-surface]');
    if (!el) return { id: 'global', el: null };
    if (!el.id) el.id = 'ink-surface-' + Math.random().toString(36).slice(2,9);
    return { id: el.id, el };
  }


  function anchorInfo(anchorId) {
    if (anchorId === 'global') return { left: 0, top: 0, visible: true };
    const el = document.getElementById(anchorId);
    if (!el) return { left: 0, top: 0, visible: false };

    const cs = getComputedStyle(el);
    const visible = cs.display !== 'none' && cs.visibility !== 'hidden';
    const expanded =
        (el.tagName.toLowerCase() !== 'details' || el.open) &&
        (!el.classList.contains('collapse') || el.classList.contains('show'));
    if (!visible || !expanded) return { left: 0, top: 0, visible: false };

    const r = el.getBoundingClientRect();
    return { left: r.left + window.scrollX, top: r.top + window.scrollY, visible: true };
  }

    // pointer in LOCAL anchor coords
  function pointerPosLocal(e, anchorEl) {
    if (!anchorEl) return { x: e.pageX, y: e.pageY, p: e.pressure>0?e.pressure:0.5 };
    const r = anchorEl.getBoundingClientRect();
    return { x: e.clientX - r.left, y: e.clientY - r.top, p: e.pressure>0?e.pressure:0.5 };
  }



  function pointerPos(e){  // page space (CSS px)
    return { x: e.pageX, y: e.pageY, p: (e.pressure>0 ? e.pressure : 0.5) };
  }


  let currentAnchor = { id: 'global', el: null };

  canvas.addEventListener('pointerdown', (e)=>{
    if (!drawingEnabled) return;
    try { canvas.setPointerCapture?.(e.pointerId); } catch {}
    currentAnchor = getAnchorAtPoint(e.clientX, e.clientY);

    const p = pointerPosLocal(e, currentAnchor.el);
    current = {
        anchorId: currentAnchor.id,
        tool,
        color: penColor,
        size: tool === 'eraser' ? eraserSize : penSize,
        points: [p],
        localBBox: {x0:p.x,y0:p.y,x1:p.x,y1:p.y}
    };
    e.preventDefault();
    scheduleRedraw();
  }, {passive:false});

  canvas.addEventListener('pointermove', (e)=>{
    if (!current) return;
    const p = pointerPosLocal(e, currentAnchor.el);
    if (pushPointDecimated(current.points, p)) {
        current.localBBox.x0 = Math.min(current.localBBox.x0, p.x);
        current.localBBox.y0 = Math.min(current.localBBox.y0, p.y);
        current.localBBox.x1 = Math.max(current.localBBox.x1, p.x);
        current.localBBox.y1 = Math.max(current.localBBox.y1, p.y);
    }
    e.preventDefault();
    scheduleRedraw();
  }, {passive:false});

// update hover position always while ink is enabled
canvas.addEventListener('pointermove', (e) => {
  if (!drawingEnabled) return;
  hoverPage = { x: e.pageX, y: e.pageY };
}, { passive: true });

canvas.addEventListener('pointerleave', () => {
  hoverPage = null;
  scheduleRedraw();
});



  function endStroke(e){
    if (!current) return;
    const p = pointerPosLocal(e, currentAnchor.el);
    if (pushPointDecimated(current.points, p)) {
        current.localBBox.x0 = Math.min(current.localBBox.x0, p.x);
        current.localBBox.y0 = Math.min(current.localBBox.y0, p.y);
        current.localBBox.x1 = Math.max(current.localBBox.x1, p.x);
        current.localBBox.y1 = Math.max(current.localBBox.y1, p.y);
    }
    recomputeMeta(current);                      // builds _localPath
    strokes.push(current);
    current = null;
    try { canvas.releasePointerCapture?.(e.pointerId); } catch {}
    save();
    scheduleRedraw();
    updateActionStates(); 

  }


  canvas.addEventListener('pointerup', endStroke);
  canvas.addEventListener('pointercancel', endStroke);
  canvas.addEventListener('pointerleave', endStroke);

  // --- hook up the toolbar buttons so clicks always â€œregisterâ€ ---
  onButton('inkpad-toggle', () => setDrawing(!drawingEnabled));
  onButton('inkpad-pen',    () => setTool('pen'));
  onButton('inkpad-eraser', () => setTool('eraser'));

onButton('inkpad-undo', () => {
  if (!strokes.length) { flash(undoBtn); showToast('Nothing to undo'); return; }
  strokes.pop(); save(); redraw();
  flash(undoBtn); showToast('Undid last stroke');
  updateActionStates();
});

onButton('inkpad-clear', () => {
  if (!strokes.length) { flash(clearBtn); showToast('Nothing to clear'); return; }
  if (confirm('Clear all ink on this page?')) {
    strokes = []; save(); redraw();
    flash(clearBtn); showToast('Cleared');
    updateActionStates();
  }
});

onButton('inkpad-save', () => {
  if (!hasInk()) { flash(saveBtn); showToast('Nothing to save'); return; }
  const url = canvas.toDataURL('image/png');
  const a = document.createElement('a');
  a.download = (document.title || 'notes') + '.png';
  a.href = url; a.click();
  flash(saveBtn); showToast('Saved PNG');
});


  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    // Only when toolbar is visible
    if (!toolbar.classList.contains('open')) return;

    // Donâ€™t hijack typing in inputs
    if (e.target && /input|textarea|select|button/i.test(e.target.tagName)) return;
    if (e.target?.isContentEditable) return;

    const k = e.key.toLowerCase();
    if (k === 'd') { setDrawing(!drawingEnabled); e.preventDefault(); }
    else if (k === 'p') { setTool('pen'); e.preventDefault(); }
    else if (k === 'e') { setTool('eraser'); e.preventDefault(); }
    else if (k === 'z' && (e.ctrlKey || e.metaKey)) { strokes.pop(); save(); redraw(); e.preventDefault(); }
  });

  window.addEventListener('resize', fitCanvas, {passive:true});

  // redraw when viewport scrolls
  window.addEventListener('scroll', scheduleRedraw, { passive: true });

  // redraw for nested scrollable containers (capture phase catches them)
  document.addEventListener('scroll', scheduleRedraw, { passive: true, capture: true });

  // stay smooth during touch scrolling
  window.addEventListener('touchmove', scheduleRedraw, { passive: true });

  // handle rotation and tab visibility
  window.addEventListener('orientationchange', scheduleRedraw, { passive: true });
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) scheduleRedraw();
  }, { passive: true });

  // respond to DPR changes (pinch-zoom)
  if (window.matchMedia) {
    const dppx = Math.round((window.devicePixelRatio || 1) * 10) / 10;
    const mq = matchMedia(`(resolution: ${dppx}dppx)`);
    mq.addEventListener?.('change', () => { fitCanvas(); }); // Safari/iOS
  }

  document.addEventListener('toggle', (e) => {
    if (e.target.tagName?.toLowerCase() === 'details') requestAnimationFrame(scheduleRedraw);
  }, true);
  document.addEventListener('show.bs.collapse', () => scheduleRedraw());
  document.addEventListener('hide.bs.collapse', () => scheduleRedraw());

  // If a details/collapse uses CSS height transitions, redraw after it ends.
  document.addEventListener('transitionend', (e) => {
    const t = e.target;
    if (!t) return;
    // common containers that change height
    if (t.matches?.('details, .collapse, .callout, [data-ink-surface]')) {
        scheduleRedraw();
    }
  }, { passive: true, capture: true });

  // Bootstrapâ€™s final state events 
  document.addEventListener('shown.bs.collapse',  () => scheduleRedraw());
  document.addEventListener('hidden.bs.collapse', () => scheduleRedraw());


  // --- initialise ---
  load(); fitCanvas();
  setDrawing(false);   // ensures initial visual state is consistent
  setTool('pen');
  updateActionStates();

  const m = new MutationObserver(() => {
    const open = toolbar.classList.contains('open');
    toolbar.setAttribute('aria-hidden', open ? 'false' : 'true');
  });
  m.observe(toolbar, {attributes:true, attributeFilter:['class']});

  // keep canvas sized if the document grows (e.g., lazy images)
  const ro = new ResizeObserver(()=> fitCanvas());
  ro.observe(document.documentElement);
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const tools = document.querySelector('#quarto-header .quarto-navbar-tools');
  if (!tools) return;

  // Avoid duplicates if hot-reloading / re-running
  if (document.getElementById('inkpad-header-toggle')) return;

  // Create the Ink button
  const inkBtn = document.createElement('button');
  inkBtn.id = 'inkpad-header-toggle';
  inkBtn.className = 'btn-ink-tool';
  inkBtn.type = 'button';
  inkBtn.setAttribute('aria-label', 'Ink controls');
  inkBtn.setAttribute('title', 'Ink controls (I)');
  inkBtn.setAttribute('aria-controls', 'inkpad-toolbar');
  inkBtn.setAttribute('aria-expanded', 'false');

  // Pen icon
  inkBtn.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
         fill="none" stroke="currentColor" stroke-width="2"
         stroke-linecap="round" stroke-linejoin="round" width="20" height="20" aria-hidden="true">
        <path d="M12 19l7-7 3 3-7 7-3-3z"/>
        <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
        <path d="M2 2l7.586 7.586"/>
        <circle cx="11" cy="11" r="2"/>
      </svg>
  `;

  // Place it after the zoom toggle, else after colour toggle, else append
  const zoomToggle  = tools.querySelector('#lecture-zoom-header-toggle');
  const colorToggle = tools.querySelector('.quarto-color-scheme-toggle');
  if (zoomToggle && zoomToggle.parentNode) {
    zoomToggle.parentNode.insertBefore(inkBtn, zoomToggle.nextSibling);
  } else if (colorToggle && colorToggle.parentNode) {
    colorToggle.parentNode.insertBefore(inkBtn, colorToggle.nextSibling);
  } else {
    tools.appendChild(inkBtn);
  }

  // Toggle behaviour: show/hide the floating ink toolbar
  const toolbar = document.getElementById('inkpad-toolbar'); // your existing floating toolbar
  const setOpen = (open) => {
    if (!toolbar) return;
    toolbar.classList.toggle('open', open);
    inkBtn.classList.toggle('active', open);
    inkBtn.setAttribute('aria-expanded', String(open));
  };

  inkBtn.addEventListener('click', () => {
    if (!toolbar) return;
    setOpen(!toolbar.classList.contains('open'));
  });

  // Keyboard: "I" toggles; "Esc" closes
  document.addEventListener('keydown', (e) => {
    if (/input|textarea|select/i.test(e.target.tagName)) return;
    if (e.key.toLowerCase() === 'i' && !e.metaKey && !e.ctrlKey && !e.altKey) {
      if (!toolbar) return;
      setOpen(!toolbar.classList.contains('open'));
    }
    if (e.key === 'Escape') setOpen(false);
  });
});
</script>

<style>
/* Header ink button look & feel */
#quarto-header .btn-ink-tool {
  background: none; border: 0;
  padding: .375rem; margin: 0 .25rem;
  border-radius: .375rem; cursor: pointer;
  color: var(--bs-navbar-color, currentColor);
  display: inline-flex; align-items: center; justify-content: center;
  transition: background .15s ease, opacity .15s ease;
}
#quarto-header .btn-ink-tool:hover { opacity: .8; color: var(--brand-teal-hover); background: rgba(255,255,255,0.08);}
#quarto-header .btn-ink-tool.active {
  background: color-mix(in srgb, var(--brand-teal) 30%, transparent);
  /* border: 1px solid var(--brand-teal);  */
  /* border-radius: .375rem;              */
}
.quarto-dark #quarto-header .btn-ink-tool { color: var(--bs-navbar-dark-color, #fff); }


</style>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../content/practicals/1-intro-to-pytorch.html" class="pagination-link" aria-label="Introduction to PyTorch">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Introduction to PyTorch</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../content/appendix/formula-sheet.html" class="pagination-link" aria-label="Formula Sheet">
        <span class="nav-page-text">Formula Sheet</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>